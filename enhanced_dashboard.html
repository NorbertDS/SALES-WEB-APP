<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics Pro - Interactive Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Professional Header Styles */
        .professional-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .professional-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 35px;
            position: relative;
            z-index: 2;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo-text h1 {
            font-size: 2rem;
            font-weight: 900;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #ffffff;
        }

        .logo-text p {
            font-size: 0.9rem;
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-weight: 300;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .currency-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .currency-label {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .currency-options {
            display: flex;
            gap: 8px;
        }

        .currency-option {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .currency-option:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .currency-option.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: nowrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-details span:first-child {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .role-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .login-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .login-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .header-nav {
            background: rgba(0, 0, 0, 0.1);
            padding: 20px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .nav-menu {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
            align-items: center;
            overflow-x: auto;
        }

        /* Hide navigation menu before login */
        .nav-menu.hidden {
            display: none !important;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .nav-btn i {
            font-size: 0.9rem;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            font-weight: 700;
        }

        .logo-text p {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-menu {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            align-items: center;
            overflow-x: auto;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn i {
            font-size: 0.9rem;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }
        
        .auth-section {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* Login Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 1000 !important;
        }
        
        .login-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: translateY(50px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .login-modal {
            transform: translateY(0);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #6b7280;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .password-container {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
        }
        
        .login-submit {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .login-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .login-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .demo-credentials {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .demo-credentials h4 {
            color: #0369a1;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .demo-credentials .credential {
            font-size: 12px;
            color: #0369a1;
            margin-bottom: 5px;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }
        
        /* Role-based access control */
        .auth-required {
            opacity: 0.3;
            pointer-events: none;
            position: relative;
        }
        
        .auth-required::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            border-radius: 20px;
            z-index: 10;
        }
        
        .auth-required::after {
            content: 'ðŸ”’ Login Required';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 16px;
            z-index: 11;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .login-prompt {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 20px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .login-prompt h3 {
            font-size: 1.5rem;
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        .login-prompt p {
            color: #6b7280;
            margin-bottom: 25px;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .role-admin {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .role-analyst {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        
        .role-viewer {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* KPI Metrics Section */
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .kpi-section-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            text-align: left;
            margin: 0;
            position: relative;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .kpi-currency-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f7fafc;
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid #e2e8f0;
        }

        .kpi-currency-selector .currency-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a5568;
        }

        .kpi-currency-selector .currency-options {
            display: flex;
            gap: 8px;
        }

        .kpi-currency-selector .currency-option {
            background: transparent;
            border: 1px solid #cbd5e0;
            color: #4a5568;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .kpi-currency-selector .currency-option:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        .kpi-currency-selector .currency-option.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .kpi-section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        .kpi-card-container {
            position: relative;
        }
        
        .expenses-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            z-index: 10;
        }
        
        .expenses-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .expenses-btn:active {
            transform: translateY(0);
        }
        
        /* Expenses Card Styling */
        .expenses-card {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .expenses-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(245, 158, 11, 0.3);
        }
        
        .expenses-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
            font-style: italic;
        }

        /* User Management Styles */
        .user-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .user-section h4 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .user-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .permissions-grid label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #4a5568;
            cursor: pointer;
        }

        .permissions-grid input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .users-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        .users-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar-large {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-details h5 {
            margin: 0;
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }

        .user-details p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 14px;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .user-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #4299e1;
            color: white;
            cursor: pointer;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-edit:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #f56565;
            color: white;
            cursor: pointer;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #e53e3e;
            transform: translateY(-1px);
        }

        .btn-toggle {
            background: #48bb78;
            color: white;
            cursor: pointer;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-toggle:hover {
            background: #38a169;
            transform: translateY(-1px);
        }

        .user-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .permission-tag {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .permission-tag.admin {
            background: #fed7d7;
            color: #c53030;
        }

        .permission-tag.analyst {
            background: #bee3f8;
            color: #2b6cb0;
        }

        .permission-tag.viewer {
            background: #c6f6d5;
            color: #2f855a;
        }

        .user-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #c6f6d5;
            color: #2f855a;
        }

        .status-inactive {
            background: #fed7d7;
            color: #c53030;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .form-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }
        
        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .kpi-card {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-title {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Responsive font size for long amounts */
        .kpi-value[data-currency="KES"] {
            font-size: 2rem;
        }
        
        .kpi-value[data-currency="KES"]:has-text("KSh1,000,000") {
            font-size: 1.8rem;
        }
        
        @media (max-width: 768px) {
            .kpi-value {
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-value {
                font-size: 1.5rem;
            }
        }
        
        .kpi-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            height: fit-content;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .data-table tr:hover {
            background: #f8fafc;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1001;
            pointer-events: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .analytics-panel {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-panel {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .admin-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .admin-card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-card h3 i {
            color: #667eea;
        }

        .employee-list, .targets-list, .commission-list, .competitor-pricing {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .employee-item, .target-item, .commission-item, .pricing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }

        .employee-name, .target-name, .commission-name, .product-name {
            font-weight: 600;
            color: #2d3748;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .active-filters {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .filter-chip {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-chip .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .filter-info {
            color: #4a5568;
            font-style: italic;
            font-size: 14px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .chart-container h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
        }

        .chart-container canvas {
            max-height: 300px;
            cursor: pointer;
        }
        
        /* Analytics Tabs */
        .analytics-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .analytics-tab-content {
            display: none;
        }
        
        .analytics-tab-content.active {
            display: block;
        }
        
        .chart-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
        }
        
        .chart-container h3 {
            margin: 0 0 20px 0;
            color: #374151;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .chart-container canvas {
            max-height: 300px;
        }
        
        @media (max-width: 768px) {
            .analytics-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 120px;
            }
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            height: 600px;
        }
        
        .analytics-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .analytics-controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }
        
        .control-group select {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-group select:hover {
            background: white;
            transform: translateY(-1px);
        }
        
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 15px;
        }
        
        .filter-chip {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .filter-chip .remove {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .refresh-section {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            gap: 15px;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .refresh-btn i {
            transition: transform 0.3s ease;
        }
        
        .refresh-btn:hover i {
            transform: rotate(180deg);
        }
        
        .last-updated {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
        }
        
        .currency-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .currency-option {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .currency-option.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .export-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        
        .export-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }
        
        .profit-loss-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .pl-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .pl-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            color: white;
        }
        
        .pl-card.revenue { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .pl-card.costs { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .pl-card.profit { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .pl-card.margin { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Professional Header -->
        <div class="professional-header">
            <!-- Top Section: Logo and User Info -->
            <div class="header-top">
                <div class="header-left">
                    <div class="logo-section">
                        <div class="logo-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="logo-text">
                            <h1>Sales Analytics Pro</h1>
                            <p>Professional Sales Management Dashboard</p>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="currency-selector">
                        <span class="currency-label">Currency:</span>
                        <div class="currency-options">
                            <button class="currency-option active" onclick="setCurrency('USD')" id="usdOption" style="display: inline-block;">
                                <i class="fas fa-dollar-sign"></i> USD
                            </button>
                            <button class="currency-option" onclick="setCurrency('KES')" id="kesOption" style="display: inline-block;">
                                <i class="fas fa-shilling-sign"></i> KES
                            </button>
                        </div>
                    </div>
                    
                    <div class="auth-section" id="authSection">
                        <div class="user-info" id="userInfo" style="display: none;">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <div class="user-details">
                                <span id="userName">Admin User</span>
                                <span id="userRole" class="role-badge role-admin">Admin</span>
                            </div>
                        </div>
                        <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                        <button class="login-btn" id="loginBtn" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <div class="header-nav">
                <div class="nav-menu hidden">
                    <button class="nav-btn" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <button class="nav-btn" onclick="openAddSaleModal()">
                        <i class="fas fa-plus"></i> Add Sale
                    </button>
                    <button class="nav-btn" onclick="openAddProductModal()">
                        <i class="fas fa-box"></i> Add Product
                    </button>
                    <button class="nav-btn" onclick="exportData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button class="nav-btn" onclick="importData()">
                        <i class="fas fa-upload"></i> Import Data
                    </button>
                    <button class="nav-btn" onclick="showAnalytics()">
                        <i class="fas fa-chart-bar"></i> View Analytics
                    </button>
                    <button class="nav-btn" onclick="generateIntelligentReport()">
                        <i class="fas fa-file-alt"></i> Report
                    </button>
                    <button class="nav-btn admin-only" onclick="showAdminPanel()" id="adminDataBtn" style="display: none;">
                        <i class="fas fa-shield-alt"></i> Admin Data
                    </button>
                    <button class="nav-btn admin-only" onclick="showUserManagement()" id="userManagementBtn" style="display: none;">
                        <i class="fas fa-users-cog"></i> User Management
                    </button>
                </div>
            </div>
            
            <!-- Server Status - positioned below navigation, aligned left -->
            <div class="status-bar" style="text-align: left; margin-top: 10px; margin-left: 0;">
                <span id="statusIndicator" class="status-indicator"></span>
                <span id="statusText">Checking API connection...</span>
            </div>
        </div>

        <!-- Login Prompt (shown when not logged in) -->
        <div class="login-prompt" id="loginPrompt" style="display: none;">
            <h3><i class="fas fa-lock"></i> Authentication Required</h3>
            <p>Please log in to access the Sales Analytics Dashboard and view your data insights.</p>
            <button class="login-btn" onclick="showLoginModal()">
                <i class="fas fa-sign-in-alt"></i> Login to Continue
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-dashboard auth-required" id="mainDashboard">
                <!-- KPI Metrics Title with Currency Selector -->
                <div class="kpi-header">
                    <h2 class="kpi-section-title">
                        <i class="fas fa-chart-bar"></i> KPI Metrics
                    </h2>
                    <div class="kpi-currency-selector">
                        <span class="currency-label">Currency:</span>
                        <div class="currency-options">
                            <button class="currency-option active" onclick="setCurrency('USD')" id="kpiUsdOption">
                                <i class="fas fa-dollar-sign"></i> USD
                            </button>
                            <button class="currency-option" onclick="setCurrency('KES')" id="kpiKesOption">
                                <i class="fas fa-shilling-sign"></i> KES
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- KPI Cards -->
                <div class="dashboard-grid" id="kpiGrid">
                    <div class="card kpi-card">
                        <div class="kpi-title">
                            <i class="fas fa-dollar-sign"></i> Revenue Overview
                        </div>
                        <div class="kpi-value" id="totalRevenue">$0</div>
                        <div class="kpi-label">Total Revenue</div>
                    </div>
                    <div class="card kpi-card">
                        <div class="kpi-title">
                            <i class="fas fa-shopping-cart"></i> Sales Activity
                        </div>
                        <div class="kpi-value" id="totalSales">0</div>
                        <div class="kpi-label">Total Sales</div>
                    </div>
                    <div class="card kpi-card">
                        <div class="kpi-title">
                            <i class="fas fa-chart-line"></i> Performance
                        </div>
                        <div class="kpi-value" id="averageSale">$0</div>
                        <div class="kpi-label">Average Sale</div>
                    </div>
                    <div class="card kpi-card">
                        <div class="kpi-title">
                            <i class="fas fa-percentage"></i> Profitability
                        </div>
                        <div class="kpi-value" id="profitMargin">0%</div>
                        <div class="kpi-label">Profit Margin</div>
                    </div>
                    <div class="card kpi-card">
                        <div class="kpi-title">
                            <i class="fas fa-chart-line"></i> Gross Profit
                        </div>
                        <div class="kpi-value" id="grossProfit">$0</div>
                        <div class="kpi-label">Gross Profit</div>
                    </div>
                    <div class="card kpi-card expenses-card" onclick="showExpensesCalculator()">
                        <div class="kpi-title">
                            <i class="fas fa-receipt"></i> Expenses
                        </div>
                        <div class="kpi-value" id="totalExpensesDisplay">$0</div>
                        <div class="kpi-label">Total Expenses</div>
                        <div class="expenses-subtitle">Click to manage</div>
                    </div>
                </div>

                <!-- Analytics Panel -->
                <div class="analytics-panel" id="analyticsPanel">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i> Visualization Dashboard - Analytics
                    </h2>
                    
                    <!-- Active Filters Display -->
                    <div class="active-filters" id="activeFilters">
                        <div class="filter-chips" id="filterChips">
                            <span class="filter-info">Click on any chart element to filter data across all visualizations</span>
                        </div>
                        <button class="btn btn-secondary" onclick="clearAllFilters()" id="clearFiltersBtn" style="display: none;">
                            <i class="fas fa-times"></i> Clear All Filters
                        </button>
                    </div>
                    
                    <!-- Analytics Tabs -->
                    <div class="analytics-tabs">
                        <button class="tab-btn active" onclick="showAnalyticsTab('overview')">Overview</button>
                        <button class="tab-btn" onclick="showAnalyticsTab('brands')">Brand Performance</button>
                        <button class="tab-btn" onclick="showAnalyticsTab('profitability')">Profitability</button>
                        <button class="tab-btn" onclick="showAnalyticsTab('trends')">Trends</button>
                        <button class="tab-btn" onclick="showAnalyticsTab('comparison')">Comparisons</button>
                    </div>
                    
                    <!-- Overview Tab -->
                    <div id="overviewTab" class="analytics-tab-content active">
                        <div class="analytics-grid">
                            <div class="chart-container">
                                <h3>Revenue Trends Over Time</h3>
                                <canvas id="revenueTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Gross Profit vs Net Profit Analysis</h3>
                                <canvas id="profitExpenseChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Brand Performance Tab -->
                    <div id="brandsTab" class="analytics-tab-content">
                        <div class="analytics-grid">
                            <div class="chart-container">
                                <h3>Top Performing Brands</h3>
                                <canvas id="topBrandsChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Brand Profit Margins</h3>
                                <canvas id="brandMarginChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profitability Tab -->
                    <div id="profitabilityTab" class="analytics-tab-content">
                        <div class="analytics-grid">
                            <div class="chart-container">
                                <h3>Gross Profit by Brand</h3>
                                <canvas id="grossProfitChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Profit Margin Analysis</h3>
                                <canvas id="profitMarginChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trends Tab -->
                    <div id="trendsTab" class="analytics-tab-content">
                        <div class="analytics-grid">
                            <div class="chart-container">
                                <h3>Sales Trends Over Time</h3>
                                <canvas id="salesTrendChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Profit Trends</h3>
                                <canvas id="profitTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Tab -->
                    <div id="comparisonTab" class="analytics-tab-content">
                        <div class="analytics-grid">
                            <div class="chart-container">
                                <h3>Expenses vs Net Profit Analysis</h3>
                                <canvas id="expensesNetProfitChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Revenue vs Cost of Goods Sold</h3>
                                <canvas id="revenueCOGSChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics Controls -->
                    <div class="analytics-controls">
                        <div style="display: flex; gap: 20px; align-items: end;">
                            <div class="control-group">
                                <label>Time Period</label>
                                <select id="timePeriod" onchange="updateTimePeriod()">
                                    <option value="day">Daily</option>
                                    <option value="week">Weekly</option>
                                    <option value="month" selected>Monthly</option>
                                    <option value="year">Yearly</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Chart 1 Type</label>
                                <select id="chart1Type" onchange="updateChartTypes()">
                                    <option value="region">Revenue by Region</option>
                                    <option value="product">Revenue by Product</option>
                                    <option value="category">Revenue by Category</option>
                                    <option value="customer">Top Customers</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Chart 2 Type</label>
                                <select id="chart2Type" onchange="updateChartTypes()">
                                    <option value="product" selected>Top Products</option>
                                    <option value="region">Revenue by Region</option>
                                    <option value="category">Revenue by Category</option>
                                    <option value="customer">Top Customers</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Performance Metric</label>
                                <select id="performanceMetric" onchange="updateChartTypes()">
                                    <option value="revenue">Revenue</option>
                                    <option value="quantity">Quantity Sold</option>
                                    <option value="transactions">Transaction Count</option>
                                    <option value="profit">Profit</option>
                                </select>
                            </div>
                        </div>
                        <div class="refresh-section" id="refreshSection">
                            <button class="refresh-btn" onclick="refreshAllData()">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                            <span class="last-updated" id="lastUpdated">
                                Last updated: <span id="lastUpdateTime">Never</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4><i class="fas fa-trending-up"></i> Sales Trends</h4>
                            <canvas id="salesTrendChart" width="500" height="250"></canvas>
                        </div>
                        <div class="analytics-card">
                            <h4 id="chart1Title"><i class="fas fa-pie-chart"></i> Revenue by Region</h4>
                            <canvas id="regionChart" width="500" height="250"></canvas>
                        </div>
                        <div class="analytics-card">
                            <h4 id="chart2Title"><i class="fas fa-box"></i> Top Products</h4>
                            <canvas id="productsChart" width="500" height="250"></canvas>
                        </div>
                        <div class="analytics-card">
                            <h4 id="chart3Title"><i class="fas fa-calendar"></i> Performance Analysis</h4>
                            <canvas id="monthlyChart" width="500" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Profit & Loss Section -->
                <div class="profit-loss-section" id="profitLossSection">
                    <h2 class="section-title">
                        <i class="fas fa-calculator"></i> Profit & Loss Statement
                    </h2>
                    <div class="pl-grid">
                        <div class="pl-card revenue">
                            <div class="kpi-value" id="plRevenue">$0</div>
                            <div class="kpi-label">Total Revenue</div>
                        </div>
                        <div class="pl-card costs">
                            <div class="kpi-value" id="plCosts">$0</div>
                            <div class="kpi-label">Total Costs</div>
                        </div>
                        <div class="pl-card profit">
                            <div class="kpi-value" id="plProfit">$0</div>
                            <div class="kpi-label">Net Profit</div>
                        </div>
                        <div class="pl-card margin">
                            <div class="kpi-value" id="plMargin">0%</div>
                            <div class="kpi-label">Profit Margin</div>
                        </div>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 20px;">Product-wise Profit Analysis</h4>
                        <div id="productProfitTable"></div>
                    </div>
                </div>


                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="input-group">
                        <select class="input" id="regionFilter" onchange="applyFilters()">
                            <option value="">All Regions</option>
                            <option value="North">North</option>
                            <option value="South">South</option>
                            <option value="East">East</option>
                            <option value="West">West</option>
                        </select>
                        <select class="input" id="sortBy" onchange="applySorting()">
                            <option value="date">Sort by Date</option>
                            <option value="amount">Sort by Amount</option>
                            <option value="customer">Sort by Customer</option>
                            <option value="region">Sort by Region</option>
                        </select>
                        <input type="text" class="input" id="searchInput" placeholder="Search..." onkeyup="applySearch()">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Admin Confidential Data Panel -->
                <div class="admin-panel" id="adminPanel" style="display: none;">
                    <h2 class="section-title">
                        <i class="fas fa-shield-alt"></i> Admin Confidential Data
                    </h2>
                    
                    <div class="admin-tabs">
                        <button class="tab-btn active" onclick="showAdminTab('financial')">Financial Reports</button>
                        <button class="tab-btn" onclick="showAdminTab('employee')">Employee Performance</button>
                        <button class="tab-btn" onclick="showAdminTab('market')">Market Analysis</button>
                    </div>
                    
                    <!-- Financial Reports Tab -->
                    <div id="financialTab" class="admin-tab-content active">
                        <div class="admin-grid">
                            <div class="admin-card">
                                <h3><i class="fas fa-dollar-sign"></i> Monthly Revenue</h3>
                                <div class="metric-value" id="monthlyRevenue">$0</div>
                                <div class="metric-label">Current Month</div>
                            </div>
                            <div class="admin-card">
                                <h3><i class="fas fa-chart-line"></i> Monthly Expenses</h3>
                                <div class="metric-value" id="monthlyExpenses">$0</div>
                                <div class="metric-label">Current Month</div>
                            </div>
                            <div class="admin-card">
                                <h3><i class="fas fa-trophy"></i> Net Profit</h3>
                                <div class="metric-value" id="netProfit">$0</div>
                                <div class="metric-label">Current Month</div>
                            </div>
                            <div class="admin-card">
                                <h3><i class="fas fa-percentage"></i> Profit Margin</h3>
                                <div class="metric-value" id="profitMargin">0%</div>
                                <div class="metric-label">Current Month</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employee Performance Tab -->
                    <div id="employeeTab" class="admin-tab-content">
                        <div class="admin-grid">
                            <div class="admin-card">
                                <h3><i class="fas fa-users"></i> Top Performers</h3>
                                <div class="employee-list" id="topPerformers">
                                    <div class="employee-item">
                                        <span class="employee-name">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-card">
                                <h3><i class="fas fa-bullseye"></i> Sales Targets</h3>
                                <div class="targets-list" id="salesTargets">
                                    <div class="target-item">
                                        <span class="target-name">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-card">
                                <h3><i class="fas fa-hand-holding-usd"></i> Commission Rates</h3>
                                <div class="commission-list" id="commissionRates">
                                    <div class="commission-item">
                                        <span class="commission-name">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Market Analysis Tab -->
                    <div id="marketTab" class="admin-tab-content">
                        <div class="admin-grid">
                            <div class="admin-card">
                                <h3><i class="fas fa-chart-pie"></i> Market Share</h3>
                                <div class="metric-value" id="marketShare">0%</div>
                                <div class="metric-label">Current Market Position</div>
                            </div>
                            <div class="admin-card">
                                <h3><i class="fas fa-trending-up"></i> Growth Rate</h3>
                                <div class="metric-value" id="growthRate">0%</div>
                                <div class="metric-label">Year over Year</div>
                            </div>
                            <div class="admin-card">
                                <h3><i class="fas fa-balance-scale"></i> Competitor Pricing</h3>
                                <div class="competitor-pricing" id="competitorPricing">
                                    <div class="pricing-item">
                                        <span class="product-name">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Data -->
                <div class="card">
                    <h2 class="section-title">
                        <i class="fas fa-shopping-cart"></i> Sales Transactions
                    </h2>
                    <div id="salesDataContainer">
                        <div class="loading">Loading sales data...</div>
                    </div>
                </div>

                <!-- Products Data -->
                <div class="card">
                    <h2 class="section-title">
                        <i class="fas fa-box"></i> Product Catalog
                    </h2>
                    <div id="productsDataContainer">
                        <div class="loading">Loading products data...</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar auth-required" id="sidebar">
                <h3 class="section-title">
                    <i class="fas fa-tachometer-alt"></i> Quick Actions
                </h3>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="btn btn-primary" onclick="loadSalesData()">
                        <i class="fas fa-sync-alt"></i> Refresh Sales
                    </button>
                    <button class="btn btn-success" onclick="loadProducts()">
                        <i class="fas fa-sync-alt"></i> Refresh Products
                    </button>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px; color: #4a5568;">API Endpoints</h4>
                    <div style="font-size: 12px; color: #6b7280; line-height: 1.6;">
                        <div><strong>Health:</strong> /health</div>
                        <div><strong>Sales:</strong> /api/sales/</div>
                        <div><strong>Products:</strong> /api/products/</div>
                        <div><strong>KPI:</strong> /api/analytics/kpi</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Sale Modal -->
    <div id="addSaleModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Add New Sale</h3>
            <form id="addSaleForm">
                <div class="form-group">
                    <label>Product ID</label>
                    <select class="input" id="saleProductId" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" class="input" id="saleCustomerName" required>
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <select class="input" id="saleCountry" required onchange="loadTowns()">
                        <option value="">Select Country</option>
                        <option value="Kenya">Kenya</option>
                        <option value="Uganda">Uganda</option>
                        <option value="Tanzania">Tanzania</option>
                        <option value="Rwanda">Rwanda</option>
                        <option value="Ethiopia">Ethiopia</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="Ghana">Ghana</option>
                        <option value="South Africa">South Africa</option>
                        <option value="Egypt">Egypt</option>
                        <option value="Morocco">Morocco</option>
                        <option value="United States">United States</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="Canada">Canada</option>
                        <option value="Germany">Germany</option>
                        <option value="France">France</option>
                        <option value="Italy">Italy</option>
                        <option value="Spain">Spain</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="Australia">Australia</option>
                        <option value="Japan">Japan</option>
                        <option value="China">China</option>
                        <option value="India">India</option>
                        <option value="Brazil">Brazil</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Argentina">Argentina</option>
                        <option value="Chile">Chile</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Town/City</label>
                    <select class="input" id="saleTown" required>
                        <option value="">Select Town/City</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" class="input" id="saleQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>Unit Price</label>
                    <input type="number" class="input" id="saleUnitPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Sale Date</label>
                    <input type="date" class="input" id="saleDate" required>
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSaleModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Sale</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Add New Product</h3>
            <form id="addProductForm">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" class="input" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select class="input" id="productCategory" required>
                        <option value="">Select Category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Appliances">Appliances</option>
                        <option value="Office Supplies">Office Supplies</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Unit Price</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" class="input" id="productUnitPrice" step="0.01" required style="flex: 1;">
                        <select class="input" id="productUnitCurrency" style="width: 80px;">
                            <option value="USD">USD</option>
                            <option value="KES">KES</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Cost Price</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" class="input" id="productCostPrice" step="0.01" required style="flex: 1;">
                        <select class="input" id="productCostCurrency" style="width: 80px;">
                            <option value="USD">USD</option>
                            <option value="KES">KES</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Dialog -->
    <div id="exportDialog" class="export-dialog">
        <div class="export-content">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-download"></i> Export Data</h3>
            <div class="form-group">
                <label>Export Format</label>
                <select class="input" id="exportFormat">
                    <option value="csv">CSV (Excel Compatible)</option>
                    <option value="json">JSON</option>
                    <option value="pdf">PDF Report</option>
                </select>
            </div>
            <div class="form-group">
                <label>Data Type</label>
                <select class="input" id="exportDataType">
                    <option value="sales">Sales Data</option>
                    <option value="products">Products Data</option>
                    <option value="analytics">Analytics Report</option>
                    <option value="profitloss">Profit & Loss Statement</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date Range (Optional)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" class="input" id="exportStartDate" style="flex: 1;">
                    <input type="date" class="input" id="exportEndDate" style="flex: 1;">
                </div>
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeExportDialog()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="performExport()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>

    <!-- Import Dialog -->
    <div id="importDialog" class="export-dialog">
        <div class="export-content">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-upload"></i> Import Data</h3>
            <div class="form-group">
                <label>Import Type</label>
                <select class="input" id="importType">
                    <option value="sales">Sales Data</option>
                    <option value="products">Products Data</option>
                    <option value="csv">CSV File (Auto-detect)</option>
                </select>
            </div>
            <div class="form-group">
                <label>File Upload</label>
                <input type="file" class="input" id="importFile" accept=".csv,.json,.xlsx" required>
                <small style="color: #666; margin-top: 5px; display: block;">
                    Supported formats: CSV, JSON, Excel (.xlsx)
                </small>
            </div>
            <div class="form-group">
                <label>Currency in File</label>
                <select class="input" id="importCurrency">
                    <option value="USD">USD</option>
                    <option value="KES">KES</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="importReplaceData" style="margin-right: 8px;">
                    Replace existing data (otherwise append)
                </label>
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeImportDialog()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performImport()">
                    <i class="fas fa-upload"></i> Import & Analyze
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Railway Backend Configuration
        const RAILWAY_URL = 'https://data-analytics-master.up.railway.app';
        
        // Use Railway URL for all API calls (no proxy needed)
        const API_BASE = RAILWAY_URL;
        
        // Debug function to test Railway connection
        function testRailwayConnection() {
            console.log('Testing Railway connection...');
            console.log('API Base URL:', API_BASE);
            
            // Test health endpoint
            fetch(`${API_BASE}/health`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('âœ… Railway connection successful:', data);
                    showNotification('âœ… Railway connection successful!', 'success');
                    return true;
                })
                .catch(error => {
                    console.error('âŒ Railway connection failed:', error);
                    showNotification('âŒ Railway connection failed: ' + error.message, 'error');
                    return false;
                });
        }
        
        // Make test functions available globally
        window.testRailwayConnection = testRailwayConnection;
        window.checkAPIStatus = checkAPIStatus;
        let salesData = [];
        let productsData = [];
        let filteredSalesData = [];
        let expensesData = []; // Add expenses data array
        let currentCurrency = 'USD';
        let currencyRate = { USD: 1, KES: 135 }; // 1 USD = 135 KES (realistic current rate)
        let charts = {};
        let activeFilters = {}; // Store active filters for cross-filtering

        // Load expenses from localStorage
        function loadExpensesFromStorage() {
            const savedExpenses = localStorage.getItem('expensesData');
            if (savedExpenses) {
                expensesData = JSON.parse(savedExpenses);
                console.log('âœ… Expenses loaded from storage:', expensesData);
            } else {
                // Initialize with sample expenses if none exist
                expensesData = [
                    { id: 1, description: 'Office Rent', amount: 2000, category: 'Fixed', date: '2024-01-01' },
                    { id: 2, description: 'Utilities', amount: 500, category: 'Variable', date: '2024-01-01' },
                    { id: 3, description: 'Marketing', amount: 1000, category: 'Marketing', date: '2024-01-01' }
                ];
                saveExpensesToStorage();
            }
        }

        // Save expenses to localStorage
        function saveExpensesToStorage() {
            localStorage.setItem('expensesData', JSON.stringify(expensesData));
        }

        // Validate calculation data
        function validateCalculationData() {
            console.log('ðŸ” Validating calculation data...');
            
            // Check sales data
            salesData.forEach((sale, index) => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (!product) {
                    console.error(`âŒ Sale ${index + 1}: Product ID ${sale.product_id} not found in products data`);
                } else {
                    const expectedTotal = sale.quantity * product.unit_price;
                    if (Math.abs(sale.total_amount - expectedTotal) > 0.01) {
                        console.warn(`âš ï¸ Sale ${index + 1}: Total amount ${sale.total_amount} doesn't match quantity Ã— unit_price (${expectedTotal})`);
                    }
                }
            });
            
            // Check products data
            productsData.forEach((product, index) => {
                if (product.cost_price > product.unit_price) {
                    console.warn(`âš ï¸ Product ${index + 1}: Cost price (${product.cost_price}) is higher than unit price (${product.unit_price})`);
                }
            });
            
            console.log('âœ… Data validation complete');
        }

        // Initialize dashboard
        async function init() {
            // Check authentication first
            checkAuthStatus();
            
            // Load expenses data from localStorage
            loadExpensesFromStorage();
            
            // Only load data if user is authenticated
            if (currentUser && authToken) {
                // Check API status in background
                checkAPIStatus();
                await loadKPIData();
                await loadSalesData();
                await loadProducts();
                setTodayDate();
                
                // Sync and fix any data inconsistencies
                syncProductData();
                
                // Ensure KPIs are calculated from local data
                updateKPIsFromLocalData();
                
                // Add sample data if no sales data exists
                if (salesData.length === 0) {
                    addSampleData();
                }
                
                // Validate calculation data
                validateCalculationData();
                
                // Initialize analytics charts if panel is visible
                const analyticsPanel = document.getElementById('analyticsPanel');
                if (analyticsPanel && analyticsPanel.style.display === 'block') {
                    setTimeout(() => {
                        createAnalyticsCharts();
                    }, 500);
                }
            } else {
                // Show login modal immediately if not authenticated
                showLoginModal();
                showNotification('ðŸ”’ Please log in to access the dashboard', 'info');
                // Check API status in background without blocking login
                setTimeout(() => {
                    checkAPIStatus();
                }, 2000);
            }
            
            // Add event delegation for user management buttons
            document.addEventListener('click', function(event) {
                if (event.target.closest('.btn-edit')) {
                    const button = event.target.closest('.btn-edit');
                    const userId = button.getAttribute('data-user-id');
                    if (userId && !button.disabled) {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log('Edit button clicked via delegation for user:', userId);
                        editUser(parseInt(userId));
                    }
                } else if (event.target.closest('.btn-toggle')) {
                    const button = event.target.closest('.btn-toggle');
                    const userId = button.getAttribute('data-user-id');
                    if (userId && !button.disabled) {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log('Toggle button clicked via delegation for user:', userId);
                        toggleUserStatus(parseInt(userId));
                    }
                } else if (event.target.closest('.btn-delete')) {
                    const button = event.target.closest('.btn-delete');
                    const userId = button.getAttribute('data-user-id');
                    if (userId && !button.disabled) {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log('Delete button clicked via delegation for user:', userId);
                        deleteUser(parseInt(userId));
                    }
                }
            });
        }

        // Sync product data to fix "Unknown" product issues
        function syncProductData() {
            // Get all unique product IDs from sales data
            const salesProductIds = [...new Set(salesData.map(sale => sale.product_id))];
            
            // Check for missing products
            const missingProducts = salesProductIds.filter(id => 
                !productsData.some(product => product.id === id)
            );
            
            if (missingProducts.length > 0) {
                console.log('Missing products found:', missingProducts);
                
                // Create placeholder products for missing IDs
                missingProducts.forEach(id => {
                    const placeholderProduct = {
                        id: id,
                        name: `Product ID: ${id}`,
                        category: 'Unknown',
                        unit_price: 0,
                        cost_price: 0
                    };
                    productsData.push(placeholderProduct);
                });
                
                showNotification(`âš ï¸ Found ${missingProducts.length} sales with missing product data. Placeholder products created.`, 'success');
            }
        }

        // Check API status with fallback
        async function checkAPIStatus() {
            try {
                console.log('ðŸ” Checking API status...', { API_BASE, url: `${API_BASE}/health` });
                
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`${API_BASE}/health`, {
                    signal: controller.signal,
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                console.log('ðŸ“¡ API Response:', { 
                    status: response.status, 
                    statusText: response.statusText,
                    ok: response.ok,
                    url: response.url 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Railway API connected:', data);
                    document.getElementById('statusText').textContent = 'âœ… Railway Server Online - Ready to show analytics!';
                    const statusIndicator = document.getElementById('statusIndicator');
                    if (statusIndicator) statusIndicator.className = 'status-indicator online';
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('âŒ Direct API Connection Error:', error);
                
                // Railway is the primary and only connection method
                console.log('ðŸ”„ Railway connection failed, will retry automatically...');
                
                if (error.name === 'AbortError') {
                    document.getElementById('statusText').textContent = 'â±ï¸ API Server Timeout - Check connection';
                } else {
                    document.getElementById('statusText').textContent = `âŒ API Server Offline - ${error.message}`;
                }
                const statusIndicator = document.getElementById('statusIndicator');
                if (statusIndicator) statusIndicator.className = 'status-indicator offline';
                return false;
            }
        }

        // Load KPI data
        async function loadKPIData() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/kpis`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                // Update KPI cards with currency conversion
                document.getElementById('totalRevenue').textContent = formatCurrency(data.total_revenue || 0);
                document.getElementById('totalSales').textContent = data.total_sales || data.total_transactions || 0;
                document.getElementById('averageSale').textContent = formatCurrency(data.average_order_value || data.average_sale_amount || 0);
                document.getElementById('profitMargin').textContent = `${(data.profit_margin || 0).toFixed(1)}%`;
                
                // Calculate and update Gross Profit
                const grossProfit = (data.total_revenue || 0) - (data.total_costs || 0);
                document.getElementById('grossProfit').textContent = formatCurrency(grossProfit);
                
                // Update Profit & Loss section
                updateProfitLoss(data);
                
                showNotification('âœ… KPI data updated successfully!', 'success');
            } catch (error) {
                console.error('KPI API error:', error);
                // Fallback to local calculation
                updateKPIsFromLocalData();
                showNotification('âš ï¸ Using local data calculation', 'warning');
            }
        }

        // Fallback function to calculate KPIs from local data
        function updateKPIsFromLocalData() {
            console.log('Calculating KPIs from local data...');
            console.log('Sales data:', salesData.length, 'sales');
            console.log('Products data:', productsData.length, 'products');
            
            const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
            const totalSales = salesData.length;
            const averageSale = totalSales > 0 ? totalRevenue / totalSales : 0;
            
            // Calculate total costs from products with detailed logging
            let totalCosts = 0;
            salesData.forEach((sale, index) => {
                const product = productsData.find(p => p.id === sale.product_id);
                const costPrice = product ? (product.cost_price || 0) : 0;
                const quantity = sale.quantity || 0;
                const saleCost = costPrice * quantity;
                totalCosts += saleCost;
                
                console.log(`Sale ${index + 1}: Product ID ${sale.product_id}, Cost Price: ${costPrice}, Quantity: ${quantity}, Sale Cost: ${saleCost}`);
                if (!product) {
                    console.warn(`Product not found for sale ${index + 1}, product_id: ${sale.product_id}`);
                    // If no product found, assume cost is 0 (don't add to totalCosts)
                }
            });
            
            // Ensure totalCosts is not negative
            totalCosts = Math.max(0, totalCosts);
            
            // Calculate Gross Profit = Total Revenue - Cost of Goods Sold
            const grossProfit = totalRevenue - totalCosts;
            
            // Calculate Net Profit = Gross Profit - Expenses
            const totalExpenses = expensesData.reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const netProfit = grossProfit - totalExpenses;
            
            // Calculate profit margin based on net profit vs revenue
            // Handle edge cases properly
            let profitMargin = 0;
            if (totalRevenue > 0) {
                profitMargin = (netProfit / totalRevenue * 100);
                // Ensure profit margin is reasonable (between -100% and 100%)
                profitMargin = Math.max(-100, Math.min(100, profitMargin));
            }
            
            // If we have no costs data but have revenue, treat as 100% profit
            if (totalCosts === 0 && totalRevenue > 0) {
                console.log('No cost data available, treating revenue as 100% profit');
                // When no costs are recorded, net profit = revenue - expenses
                const netProfit = totalRevenue - totalExpenses;
                profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
                console.log('Calculated net profit with no costs:', { totalRevenue, totalExpenses, netProfit, profitMargin });
            }
            
            console.log('Calculated values:', {
                totalRevenue,
                totalCosts,
                grossProfit,
                totalExpenses,
                netProfit,
                profitMargin: profitMargin.toFixed(1) + '%',
                salesData: salesData,
                productsData: productsData,
                expensesData: expensesData
            });
            
            // Update KPI cards
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('averageSale').textContent = formatCurrency(averageSale);
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
            
            // Update Gross Profit (Revenue - COGS)
            document.getElementById('grossProfit').textContent = formatCurrency(grossProfit);
            
            // Add validation warnings if calculations seem off
            if (netProfit < 0 && totalExpenses === 0) {
                console.warn('âš ï¸ Net profit is negative with zero expenses. This indicates cost calculation issues.');
                console.warn('Check if product cost prices are correct or if there are data mismatches.');
            }
            
            // Update Profit & Loss section with corrected values
            document.getElementById('plRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('plCosts').textContent = formatCurrency(totalCosts);
            document.getElementById('plProfit').textContent = formatCurrency(netProfit);
            document.getElementById('plMargin').textContent = `${profitMargin.toFixed(1)}%`;
            
            // Add visual indicators for negative values
            const profitElement = document.getElementById('plProfit');
            const marginElement = document.getElementById('plMargin');
            
            if (netProfit < 0) {
                profitElement.style.color = '#ef4444'; // Red for negative profit
            } else {
                profitElement.style.color = '#10b981'; // Green for positive profit
            }
            
            if (profitMargin < 0) {
                marginElement.style.color = '#ef4444'; // Red for negative margin
            } else {
                marginElement.style.color = '#10b981'; // Green for positive margin
            }
        }

        // Load sales data
        async function loadSalesData() {
            try {
                console.log('Loading sales data...', { API_BASE, authToken: authToken ? 'present' : 'missing' });
                const response = await fetch(`${API_BASE}/api/sales`, {
                    headers: getAuthHeaders()
                });
                
                console.log('Sales response:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                salesData = await response.json();
                filteredSalesData = [...salesData];
                renderSalesTable();
                
                // Ensure products data is loaded before calculating costs
                if (productsData.length === 0) {
                    await loadProducts();
                }
                
                // Update KPIs after loading sales data
                updateKPIsFromLocalData();
                
                showNotification('âœ… Sales data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading sales data:', error);
                document.getElementById('salesDataContainer').innerHTML = '<div class="error">âŒ Failed to load sales data</div>';
                showNotification('âŒ Failed to load sales data: ' + error.message, 'error');
            }
        }

        // Load products data
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/api/products`, {
                    headers: getAuthHeaders()
                });
                productsData = await response.json();
                renderProductsTable();
                populateProductSelect();
                showNotification('âœ… Products data loaded successfully!', 'success');
            } catch (error) {
                document.getElementById('productsDataContainer').innerHTML = '<div class="error">âŒ Failed to load products data</div>';
            }
        }

        // Render sales table
        function renderSalesTable(dataToRender = null) {
            const container = document.getElementById('salesDataContainer');
            const data = dataToRender || filteredSalesData;
            if (data.length === 0) {
                container.innerHTML = '<div class="loading">No sales data found</div>';
                return;
            }

            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> ID</th>
                                <th><i class="fas fa-box"></i> Product</th>
                                <th><i class="fas fa-user"></i> Customer</th>
                                <th><i class="fas fa-map-marker-alt"></i> Region</th>
                                <th><i class="fas fa-sort-numeric-up"></i> Qty</th>
                                <th><i class="fas fa-dollar-sign"></i> Amount</th>
                                <th><i class="fas fa-calendar"></i> Date</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                const productName = product ? product.name : `Product ID: ${sale.product_id}`;
                const productStyle = product ? '' : 'style="color: #ef4444; font-style: italic;"';
                
                tableHTML += `
                    <tr>
                        <td>${sale.id}</td>
                        <td ${productStyle}>${productName}</td>
                        <td>${sale.customer_name}</td>
                        <td><span style="padding: 4px 8px; background: #e2e8f0; border-radius: 6px; font-size: 12px;">${sale.region}</span></td>
                        <td>${sale.quantity}</td>
                        <td><strong>${formatCurrency(sale.total_amount)}</strong></td>
                        <td>${new Date(sale.sale_date).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editSale(${sale.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteSale(${sale.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Render products table
        function renderProductsTable() {
            const container = document.getElementById('productsDataContainer');
            if (productsData.length === 0) {
                container.innerHTML = '<div class="loading">No products found</div>';
                return;
            }

            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> ID</th>
                                <th><i class="fas fa-box"></i> Name</th>
                                <th><i class="fas fa-tags"></i> Category</th>
                                <th><i class="fas fa-dollar-sign"></i> Price</th>
                                <th><i class="fas fa-coins"></i> Cost</th>
                                <th><i class="fas fa-percentage"></i> Margin</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            productsData.forEach(product => {
                const margin = ((product.unit_price - product.cost_price) / product.unit_price * 100).toFixed(1);
                const marginColor = margin > 20 ? '#10b981' : margin > 10 ? '#f59e0b' : '#ef4444';
                
                tableHTML += `
                    <tr>
                        <td>${product.id}</td>
                        <td><strong>${product.name}</strong></td>
                        <td><span style="padding: 4px 8px; background: #e2e8f0; border-radius: 6px; font-size: 12px;">${product.category}</span></td>
                        <td>${formatCurrency(product.unit_price)}</td>
                        <td>${formatCurrency(product.cost_price)}</td>
                        <td><span style="color: ${marginColor}; font-weight: bold;">${margin}%</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Populate product select for add sale form
        function populateProductSelect() {
            const select = document.getElementById('saleProductId');
            select.innerHTML = '<option value="">Select Product</option>';
            productsData.forEach(product => {
                select.innerHTML += `<option value="${product.id}">${product.name} - ${formatCurrency(product.unit_price)}</option>`;
            });
        }

        // Global regions data
        const globalRegions = {
            'Kenya': ['Nairobi', 'Mombasa', 'Kisumu', 'Nakuru', 'Eldoret', 'Thika', 'Malindi', 'Kitale', 'Garissa', 'Kakamega'],
            'Uganda': ['Kampala', 'Entebbe', 'Jinja', 'Mbale', 'Gulu', 'Lira', 'Masaka', 'Mbarara', 'Fort Portal', 'Arua'],
            'Tanzania': ['Dar es Salaam', 'Arusha', 'Mwanza', 'Dodoma', 'Tanga', 'Morogoro', 'Zanzibar', 'Mbeya', 'Iringa', 'Tabora'],
            'Rwanda': ['Kigali', 'Butare', 'Gitarama', 'Ruhengeri', 'Gisenyi', 'Byumba', 'Cyangugu', 'Kibuye', 'Rwamagana', 'Nyagatare'],
            'Ethiopia': ['Addis Ababa', 'Dire Dawa', 'Mekele', 'Gondar', 'Bahir Dar', 'Awassa', 'Jimma', 'Harar', 'Dessie', 'Nazret'],
            'Nigeria': ['Lagos', 'Abuja', 'Kano', 'Ibadan', 'Port Harcourt', 'Benin City', 'Kaduna', 'Jos', 'Ilorin', 'Ogbomoso'],
            'Ghana': ['Accra', 'Kumasi', 'Tamale', 'Sekondi-Takoradi', 'Sunyani', 'Cape Coast', 'Koforidua', 'Techiman', 'Ho', 'Bolgatanga'],
            'South Africa': ['Johannesburg', 'Cape Town', 'Durban', 'Pretoria', 'Port Elizabeth', 'Bloemfontein', 'East London', 'Pietermaritzburg', 'Nelspruit', 'Polokwane'],
            'Egypt': ['Cairo', 'Alexandria', 'Giza', 'Shubra El Kheima', 'Port Said', 'Suez', 'Luxor', 'Mansoura', 'Tanta', 'Asyut'],
            'Morocco': ['Casablanca', 'Rabat', 'Fez', 'Marrakech', 'Agadir', 'Tangier', 'Meknes', 'Oujda', 'Kenitra', 'Tetouan'],
            'United States': ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose'],
            'United Kingdom': ['London', 'Birmingham', 'Manchester', 'Glasgow', 'Liverpool', 'Leeds', 'Sheffield', 'Edinburgh', 'Bristol', 'Leicester'],
            'Canada': ['Toronto', 'Montreal', 'Vancouver', 'Calgary', 'Edmonton', 'Ottawa', 'Winnipeg', 'Quebec City', 'Hamilton', 'Kitchener'],
            'Germany': ['Berlin', 'Hamburg', 'Munich', 'Cologne', 'Frankfurt', 'Stuttgart', 'DÃ¼sseldorf', 'Dortmund', 'Essen', 'Leipzig'],
            'France': ['Paris', 'Marseille', 'Lyon', 'Toulouse', 'Nice', 'Nantes', 'Strasbourg', 'Montpellier', 'Bordeaux', 'Lille'],
            'Italy': ['Rome', 'Milan', 'Naples', 'Turin', 'Palermo', 'Genoa', 'Bologna', 'Florence', 'Bari', 'Catania'],
            'Spain': ['Madrid', 'Barcelona', 'Valencia', 'Seville', 'Zaragoza', 'MÃ¡laga', 'Murcia', 'Palma', 'Las Palmas', 'Bilbao'],
            'Netherlands': ['Amsterdam', 'Rotterdam', 'The Hague', 'Utrecht', 'Eindhoven', 'Tilburg', 'Groningen', 'Almere', 'Breda', 'Nijmegen'],
            'Australia': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide', 'Gold Coast', 'Newcastle', 'Canberra', 'Wollongong', 'Hobart'],
            'Japan': ['Tokyo', 'Yokohama', 'Osaka', 'Nagoya', 'Sapporo', 'Fukuoka', 'Kobe', 'Kyoto', 'Kawasaki', 'Saitama'],
            'China': ['Shanghai', 'Beijing', 'Chongqing', 'Tianjin', 'Guangzhou', 'Shenzhen', 'Wuhan', 'Dongguan', 'Chengdu', 'Nanjing'],
            'India': ['Mumbai', 'Delhi', 'Bangalore', 'Hyderabad', 'Ahmedabad', 'Chennai', 'Kolkata', 'Surat', 'Pune', 'Jaipur'],
            'Brazil': ['SÃ£o Paulo', 'Rio de Janeiro', 'BrasÃ­lia', 'Salvador', 'Fortaleza', 'Belo Horizonte', 'Manaus', 'Curitiba', 'Recife', 'GoiÃ¢nia'],
            'Mexico': ['Mexico City', 'Guadalajara', 'Monterrey', 'Puebla', 'Tijuana', 'LeÃ³n', 'JuÃ¡rez', 'Zapopan', 'NezahualcÃ³yotl', 'Chihuahua'],
            'Argentina': ['Buenos Aires', 'CÃ³rdoba', 'Rosario', 'Mendoza', 'La Plata', 'TucumÃ¡n', 'Mar del Plata', 'Salta', 'Santa Fe', 'San Juan'],
            'Chile': ['Santiago', 'ValparaÃ­so', 'ConcepciÃ³n', 'La Serena', 'Antofagasta', 'Temuco', 'Rancagua', 'Talca', 'Arica', 'ChillÃ¡n'],
            'Other': ['Other Location']
        };

        // Load towns based on country selection
        function loadTowns() {
            const countrySelect = document.getElementById('saleCountry');
            const townSelect = document.getElementById('saleTown');
            const selectedCountry = countrySelect.value;
            
            // Clear existing options
            townSelect.innerHTML = '<option value="">Select Town/City</option>';
            
            if (selectedCountry && globalRegions[selectedCountry]) {
                globalRegions[selectedCountry].forEach(town => {
                    const option = document.createElement('option');
                    option.value = town;
                    option.textContent = town;
                    townSelect.appendChild(option);
                });
            }
        }

        // Modal functions
        function openAddSaleModal() {
            document.getElementById('addSaleModal').style.display = 'block';
        }

        function openAddProductModal() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Set today's date
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('saleDate').value = today;
        }

        // Filter and sort functions
        function applyFilters() {
            const regionFilter = document.getElementById('regionFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredSalesData = salesData.filter(sale => {
                const matchesRegion = !regionFilter || sale.region === regionFilter;
                const matchesSearch = !searchTerm || 
                    sale.customer_name.toLowerCase().includes(searchTerm) ||
                    sale.region.toLowerCase().includes(searchTerm);
                return matchesRegion && matchesSearch;
            });
            
            renderSalesTable();
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            filteredSalesData.sort((a, b) => {
                switch(sortBy) {
                    case 'date': return new Date(a.sale_date) - new Date(b.sale_date);
                    case 'amount': return b.total_amount - a.total_amount;
                    case 'customer': return a.customer_name.localeCompare(b.customer_name);
                    case 'region': return a.region.localeCompare(b.region);
                    default: return 0;
                }
            });
            renderSalesTable();
        }

        function applySearch() {
            applyFilters();
        }

        function clearFilters() {
            document.getElementById('regionFilter').value = '';
            document.getElementById('sortBy').value = 'date';
            document.getElementById('searchInput').value = '';
            filteredSalesData = [...salesData];
            renderSalesTable();
        }

        // Form submissions
        document.getElementById('addSaleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check authentication and permissions
            if (!currentUser) {
                showNotification('âŒ Please log in to add sales', 'error');
                showLoginModal();
                return;
            }
            
            if (currentUser.role === 'viewer') {
                showNotification('âŒ Viewers cannot add sales. Contact an admin or analyst.', 'error');
                return;
            }
            
            const saleData = {
                product_id: parseInt(document.getElementById('saleProductId').value),
                quantity: parseInt(document.getElementById('saleQuantity').value),
                unit_price: parseFloat(document.getElementById('saleUnitPrice').value),
                total_amount: parseInt(document.getElementById('saleQuantity').value) * parseFloat(document.getElementById('saleUnitPrice').value),
                sale_date: document.getElementById('saleDate').value,
                region: `${document.getElementById('saleCountry').value}, ${document.getElementById('saleTown').value}`,
                customer_name: document.getElementById('saleCustomerName').value,
                salesperson: currentUser.name || 'Unknown'
            };

            try {
                const response = await fetch(`${API_BASE}/api/sales/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(saleData)
                });

                if (response.ok) {
                    showNotification('âœ… Sale added successfully!', 'success');
                    closeModal('addSaleModal');
                    document.getElementById('addSaleForm').reset();
                    setTodayDate();
                    await loadSalesData();
                    updateKPIsFromLocalData(); // Calculate from actual sales data
                } else {
                    throw new Error('Failed to add sale');
                }
            } catch (error) {
                showNotification('âŒ Failed to add sale', 'error');
            }
        });

        // Add product form handler
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check authentication and permissions
            if (!currentUser) {
                showNotification('âŒ Please log in to add products', 'error');
                showLoginModal();
                return;
            }
            
            if (currentUser.role === 'viewer') {
                showNotification('âŒ Viewers cannot add products. Contact an admin or analyst.', 'error');
                return;
            }
            
            const unitPrice = parseFloat(document.getElementById('productUnitPrice').value);
            const costPrice = parseFloat(document.getElementById('productCostPrice').value);
            const unitCurrency = document.getElementById('productUnitCurrency').value;
            const costCurrency = document.getElementById('productCostCurrency').value;
            
            // Convert to USD for storage
            const unitPriceUSD = unitCurrency === 'KES' ? unitPrice / currencyRate.KES : unitPrice;
            const costPriceUSD = costCurrency === 'KES' ? costPrice / currencyRate.KES : costPrice;
            
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                unit_price: unitPriceUSD,
                cost_price: costPriceUSD
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/products/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    const newProduct = await response.json();
                    showNotification('âœ… Product added successfully!', 'success');
                    closeModal('addProductModal');
                    document.getElementById('addProductForm').reset();
                    
                    // Refresh all data
                    await loadProducts();
                    await loadSalesData();
                    updateKPIsFromLocalData(); // Calculate from actual data
                    updateProfitLoss();
                    
                    // Refresh tables
                    renderProductsTable();
                    renderSalesTable();
                } else {
                    const errorData = await response.json();
                    showNotification(`âŒ Failed to add product: ${errorData.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Product submission error:', error);
                showNotification(`âŒ Error adding product: ${error.message}`, 'error');
            }
        });

        // Utility functions
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 8080);
        }

        function exportData() {
            showNotification('ðŸ“Š Export feature coming soon!', 'success');
        }

        function showAnalytics() {
            showNotification('ðŸ“ˆ Analytics feature coming soon!', 'success');
        }

        function generateReport() {
            showNotification('ðŸ“„ Report generation coming soon!', 'success');
        }

        // Currency functions
        function setCurrency(currency) {
            currentCurrency = currency;
            document.getElementById('usdOption').classList.toggle('active', currency === 'USD');
            document.getElementById('kesOption').classList.toggle('active', currency === 'KES');
            
            // Update KPI currency buttons
            document.getElementById('kpiUsdOption').classList.toggle('active', currency === 'USD');
            document.getElementById('kpiKesOption').classList.toggle('active', currency === 'KES');
            
            console.log('Currency changed to:', currency, 'Rate:', currencyRate[currency]);
            
            // Only update currency display, don't reload data
            updateCurrencyDisplay();
            
            showNotification(`ðŸ’° Currency changed to ${currency}`, 'success');
        }

        function updateCurrencyDisplay() {
            console.log('Updating currency display to:', currentCurrency);
            
            // Use the enhanced function with data attributes
            updateCurrencyDisplayWithAttributes();
            
            // Update profit margin percentage (no conversion needed)
            const plMarginElement = document.getElementById('plMargin');
            if (plMarginElement) {
                // Keep the existing percentage value
                const currentMargin = plMarginElement.textContent;
                if (currentMargin && currentMargin.includes('%')) {
                    plMarginElement.textContent = currentMargin;
                }
            }
            
            // Update charts with new currency
            if (Object.keys(charts).length > 0) {
                createAnalyticsCharts();
            }
            
            // Update admin data if panel is visible
            const adminPanel = document.getElementById('adminPanel');
            if (adminPanel && adminPanel.style.display === 'block') {
                loadAdminData();
            }
            
            // Update all tables and charts
            renderSalesTable();
            renderProductsTable();
            updateProductProfitTable();
            
            // Update analytics charts
            if (typeof updateCharts === 'function') {
                updateCharts();
            }
        }

        function formatCurrency(amount) {
            if (isNaN(amount) || amount === null || amount === undefined) {
                return currentCurrency === 'USD' ? '$0' : 'KSh0';
            }
            
            console.log(`Formatting currency: ${amount} in ${currentCurrency}`);
            
            // Convert from USD base to target currency
            let convertedAmount;
            if (currentCurrency === 'USD') {
                convertedAmount = amount; // Already in USD
            } else {
                convertedAmount = amount * currencyRate[currentCurrency]; // Convert to KES
            }
            
            const symbol = currentCurrency === 'USD' ? '$' : 'KSh';
            const formatted = `${symbol}${convertedAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            
            console.log(`Formatted result: ${formatted}`);
            return formatted;
        }
        
        function updateCurrencyDisplayWithAttributes() {
            console.log('Updating currency display with attributes for:', currentCurrency);
            
            // Update currency display and add data attributes for responsive styling
            const elementsToUpdate = [
                'totalRevenue', 'averageSale', 'grossProfit', 'totalExpensesDisplay',
                'plRevenue', 'plCosts', 'plProfit'
            ];
            
            elementsToUpdate.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element && element.textContent) {
                    const currentValue = parseFloat(element.textContent.replace(/[^0-9.-]+/g, ''));
                    if (!isNaN(currentValue)) {
                        // Convert from current displayed currency to USD base, then to target currency
                        let baseValue;
                        if (element.textContent.includes('KSh')) {
                            // Currently displaying KES, convert to USD base
                            baseValue = currentValue / currencyRate['KES'];
                            console.log(`Converting from KES ${currentValue} to USD base ${baseValue}`);
                        } else {
                            // Currently displaying USD
                            baseValue = currentValue;
                            console.log(`Already USD base ${baseValue}`);
                        }
                        
                        // Update the element with new currency
                        const newValue = formatCurrency(baseValue);
                        element.textContent = newValue;
                        console.log(`Updated ${elementId} to ${newValue}`);
                        
                        // Add data attribute for responsive styling
                        element.setAttribute('data-currency', currentCurrency);
                    }
                }
            });
        }

        // Analytics functions
        // Duplicate function removed - using the more complete version below
        
        // Analytics Tab Functions
        function showAnalyticsTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.analytics-tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.analytics-tabs .tab-btn');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load charts for the selected tab
            setTimeout(() => {
                loadTabCharts(tabName);
            }, 100);
        }
        
        function loadTabCharts(tabName) {
            switch(tabName) {
                case 'overview':
                    createRevenueTrendChart();
                    createProfitExpenseChart();
                    break;
                case 'brands':
                    createTopBrandsChart();
                    createBrandMarginChart();
                    break;
                case 'profitability':
                    createGrossProfitChart();
                    createProfitMarginChart();
                    break;
                case 'trends':
                    createSalesTrendChart();
                    createProfitTrendChart();
                    break;
                case 'comparison':
                    createExpensesNetProfitChart();
                    createRevenueCOGSChart();
                    break;
            }
        }

        function createAnalyticsCharts() {
            console.log('Creating analytics charts...');
            console.log('Sales data available:', salesData.length, 'sales');
            console.log('Products data available:', productsData.length, 'products');
            
            // Destroy existing charts first
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
            
            // Initialize all charts
            createRevenueTrendChart();
            createProfitExpenseChart();
            createTopBrandsChart();
            createBrandMarginChart();
            createGrossProfitChart();
            createProfitMarginChart();
            createSalesTrendChart();
            createProfitTrendChart();
            createExpensesNetProfitChart();
            createRevenueCOGSChart();
            
            console.log('Analytics charts created successfully');
        }
        
        // Add sample data for demonstration
        function addSampleData() {
            console.log('Adding sample data for analytics demonstration...');
            
            // Add sample products
            const sampleProducts = [
                { id: 1, name: 'Laptop Pro', category: 'Electronics', unit_price: 1200, cost_price: 800 },
                { id: 2, name: 'Office Chair', category: 'Furniture', unit_price: 300, cost_price: 180 },
                { id: 3, name: 'Wireless Mouse', category: 'Electronics', unit_price: 50, cost_price: 25 },
                { id: 4, name: 'Desk Lamp', category: 'Furniture', unit_price: 80, cost_price: 45 },
                { id: 5, name: 'Monitor 24"', category: 'Electronics', unit_price: 400, cost_price: 250 }
            ];
            
            productsData.push(...sampleProducts);
            
            // Add sample sales
            const sampleSales = [
                { id: 1, product_id: 1, customer_name: 'John Doe', quantity: 2, total_amount: 2400, sale_date: '2024-01-15', region: 'Nairobi, Kenya', salesperson: 'Admin' },
                { id: 2, product_id: 2, customer_name: 'Jane Smith', quantity: 1, total_amount: 300, sale_date: '2024-01-16', region: 'Mombasa, Kenya', salesperson: 'Admin' },
                { id: 3, product_id: 3, customer_name: 'Bob Johnson', quantity: 5, total_amount: 250, sale_date: '2024-01-17', region: 'Kisumu, Kenya', salesperson: 'Admin' },
                { id: 4, product_id: 4, customer_name: 'Alice Brown', quantity: 3, total_amount: 240, sale_date: '2024-01-18', region: 'Nairobi, Kenya', salesperson: 'Admin' },
                { id: 5, product_id: 5, customer_name: 'Charlie Wilson', quantity: 1, total_amount: 400, sale_date: '2024-01-19', region: 'Eldoret, Kenya', salesperson: 'Admin' },
                { id: 6, product_id: 1, customer_name: 'David Lee', quantity: 1, total_amount: 1200, sale_date: '2024-02-01', region: 'Nairobi, Kenya', salesperson: 'Admin' },
                { id: 7, product_id: 2, customer_name: 'Emma Davis', quantity: 2, total_amount: 600, sale_date: '2024-02-02', region: 'Mombasa, Kenya', salesperson: 'Admin' },
                { id: 8, product_id: 3, customer_name: 'Frank Miller', quantity: 3, total_amount: 150, sale_date: '2024-02-03', region: 'Kisumu, Kenya', salesperson: 'Admin' }
            ];
            
            salesData.push(...sampleSales);
            
            // Add sample expenses
            const sampleExpenses = [
                { id: 1, description: 'Office Rent', type: 'Fixed', amount: 2000, date: '2024-01-01' },
                { id: 2, description: 'Utilities', type: 'Variable', amount: 500, date: '2024-01-15' },
                { id: 3, description: 'Marketing', type: 'Variable', amount: 800, date: '2024-01-20' },
                { id: 4, description: 'Equipment Maintenance', type: 'Variable', amount: 300, date: '2024-02-01' }
            ];
            
            expensesData.push(...sampleExpenses);
            
            console.log('Sample data added:', {
                products: productsData.length,
                sales: salesData.length,
                expenses: expensesData.length
            });
            
            // Update displays
            updateKPIsFromLocalData();
            renderSalesTable();
            renderProductsTable();
        }
        
        // Helper function to get time-based data
        function getTimeData(data) {
            const timeData = {};
            data.forEach(sale => {
                const date = new Date(sale.sale_date);
                const month = date.toISOString().substring(0, 7); // YYYY-MM format
                
                if (!timeData[month]) {
                    timeData[month] = { revenue: 0, count: 0 };
                }
                timeData[month].revenue += sale.total_amount || 0;
                timeData[month].count += 1;
            });
            return timeData;
        }
        
        // Chart Creation Functions
        function createRevenueTrendChart() {
            const ctx = document.getElementById('revenueTrendChart');
            if (!ctx) return;
            
            const timeData = getTimeData(filteredSalesData.length > 0 ? filteredSalesData : salesData);
            const labels = Object.keys(timeData).sort();
            
            // If no data, show a message
            if (labels.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const context = ctx.getContext('2d');
                context.fillStyle = '#666';
                context.font = '16px Arial';
                context.textAlign = 'center';
                context.fillText('No sales data available', ctx.width / 2, ctx.height / 2);
                return;
            }
            
            const revenue = labels.map(key => timeData[key].revenue * currencyRate[currentCurrency]);
            
            charts.revenueTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenue,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const timePeriod = labels[elementIndex];
                            // Extract month from time period for filtering
                            if (timePeriod.includes(' ')) {
                                const month = timePeriod.split(' ')[0];
                                addFilter('month', month);
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Revenue Trends Over Time (Click to filter)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createProfitExpenseChart() {
            const ctx = document.getElementById('profitExpenseChart');
            if (!ctx) return;
            
            const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
            const totalCosts = salesData.reduce((sum, sale) => {
                const product = productsData.find(p => p.id === sale.product_id);
                return sum + ((product ? product.cost_price : 0) * (sale.quantity || 0));
            }, 0);
            const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            const grossProfit = totalRevenue - totalCosts;
            const netProfit = grossProfit - totalExpenses;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Revenue', 'Gross Profit', 'Expenses', 'Net Profit'],
                    datasets: [{
                        label: 'Amount',
                        data: [
                            totalRevenue * currencyRate[currentCurrency],
                            grossProfit * currencyRate[currentCurrency],
                            totalExpenses * currencyRate[currentCurrency],
                            netProfit * currencyRate[currentCurrency]
                        ],
                        backgroundColor: ['#10b981', '#3b82f6', '#ef4444', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Gross Profit vs Net Profit Analysis'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createTopBrandsChart() {
            const ctx = document.getElementById('topBrandsChart');
            if (!ctx) return;
            
            const productData = {};
            (filteredSalesData.length > 0 ? filteredSalesData : salesData).forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    productData[product.name] = (productData[product.name] || 0) + sale.total_amount;
                }
            });
            
            const sorted = Object.entries(productData).sort(([,a], [,b]) => b - a).slice(0, 10);
            
            charts.topBrandsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([name]) => name),
                    datasets: [{
                        label: 'Sales Revenue',
                        data: sorted.map(([,amount]) => amount * currencyRate[currentCurrency]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const brandName = sorted[elementIndex][0];
                            addFilter('brand', brandName);
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Performing Brands (Click to filter)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createBrandMarginChart() {
            const ctx = document.getElementById('brandMarginChart');
            if (!ctx) return;
            
            const productData = {};
            salesData.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    if (!productData[product.name]) {
                        productData[product.name] = { revenue: 0, costs: 0 };
                    }
                    productData[product.name].revenue += sale.total_amount;
                    productData[product.name].costs += (product.cost_price || 0) * (sale.quantity || 0);
                }
            });
            
            const margins = Object.entries(productData)
                .map(([name, data]) => ({
                    name,
                    margin: data.revenue > 0 ? ((data.revenue - data.costs) / data.revenue * 100) : 0
                }))
                .sort((a, b) => b.margin - a.margin)
                .slice(0, 10);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: margins.map(item => item.name),
                    datasets: [{
                        label: 'Profit Margin (%)',
                        data: margins.map(item => item.margin),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Brand Profit Margins'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createGrossProfitChart() {
            const ctx = document.getElementById('grossProfitChart');
            if (!ctx) return;
            
            const productData = {};
            salesData.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    if (!productData[product.name]) {
                        productData[product.name] = { revenue: 0, costs: 0 };
                    }
                    productData[product.name].revenue += sale.total_amount;
                    productData[product.name].costs += (product.cost_price || 0) * (sale.quantity || 0);
                }
            });
            
            const grossProfits = Object.entries(productData)
                .map(([name, data]) => ({
                    name,
                    grossProfit: data.revenue - data.costs
                }))
                .sort((a, b) => b.grossProfit - a.grossProfit)
                .slice(0, 10);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: grossProfits.map(item => item.name),
                    datasets: [{
                        label: 'Gross Profit',
                        data: grossProfits.map(item => item.grossProfit * currencyRate[currentCurrency]),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Gross Profit by Brand'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createProfitMarginChart() {
            const ctx = document.getElementById('profitMarginChart');
            if (!ctx) return;
            
            const productData = {};
            salesData.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    if (!productData[product.name]) {
                        productData[product.name] = { revenue: 0, costs: 0 };
                    }
                    productData[product.name].revenue += sale.total_amount;
                    productData[product.name].costs += (product.cost_price || 0) * (sale.quantity || 0);
                }
            });
            
            const margins = Object.entries(productData)
                .map(([name, data]) => ({
                    name,
                    margin: data.revenue > 0 ? ((data.revenue - data.costs) / data.revenue * 100) : 0
                }))
                .sort((a, b) => b.margin - a.margin)
                .slice(0, 10);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: margins.map(item => item.name),
                    datasets: [{
                        data: margins.map(item => item.margin),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                            '#ffecd2', '#fcb69f'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Profit Margin Distribution'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function createSalesTrendChart() {
            const ctx = document.getElementById('salesTrendChart');
            if (!ctx) return;
            
            const timeData = getTimeData(salesData);
            const labels = Object.keys(timeData).sort();
            const revenue = labels.map(key => timeData[key].revenue * currencyRate[currentCurrency]);
            const counts = labels.map(key => timeData[key].count);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenue,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Sales Count',
                        data: counts,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sales Trends Over Time'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }
        
        function createProfitTrendChart() {
            const ctx = document.getElementById('profitTrendChart');
            if (!ctx) return;
            
            const timeData = getTimeData(salesData);
            const labels = Object.keys(timeData).sort();
            const profit = labels.map(key => timeData[key].profit * currencyRate[currentCurrency]);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit',
                        data: profit,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Profit Trends Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createExpensesNetProfitChart() {
            const ctx = document.getElementById('expensesNetProfitChart');
            if (!ctx) return;
            
            // Calculate total expenses and net profit
            const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
            const totalCosts = salesData.reduce((sum, sale) => {
                const product = productsData.find(p => p.id === sale.product_id);
                return sum + ((product ? product.cost_price : 0) * (sale.quantity || 0));
            }, 0);
            const grossProfit = totalRevenue - totalCosts;
            const netProfit = grossProfit - totalExpenses;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total Expenses', 'Net Profit'],
                    datasets: [{
                        label: 'Amount',
                        data: [
                            totalExpenses * currencyRate[currentCurrency],
                            netProfit * currencyRate[currentCurrency]
                        ],
                        backgroundColor: [
                            totalExpenses < 0 ? '#ef4444' : '#f59e0b',
                            netProfit < 0 ? '#ef4444' : '#10b981'
                        ],
                        borderColor: [
                            totalExpenses < 0 ? '#dc2626' : '#d97706',
                            netProfit < 0 ? '#dc2626' : '#059669'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Expenses vs Net Profit Analysis'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createRevenueCOGSChart() {
            const ctx = document.getElementById('revenueCOGSChart');
            if (!ctx) return;
            
            // Calculate total revenue and cost of goods sold
            const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
            const totalCOGS = salesData.reduce((sum, sale) => {
                const product = productsData.find(p => p.id === sale.product_id);
                return sum + ((product ? product.cost_price : 0) * (sale.quantity || 0));
            }, 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total Revenue', 'Cost of Goods Sold'],
                    datasets: [{
                        label: 'Amount',
                        data: [
                            totalRevenue * currencyRate[currentCurrency],
                            totalCOGS * currencyRate[currentCurrency]
                        ],
                        backgroundColor: [
                            '#667eea',
                            '#f59e0b'
                        ],
                        borderColor: [
                            '#5a67d8',
                            '#d97706'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Revenue vs Cost of Goods Sold'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateCharts() {
            const monthlyData = getMonthlySalesData();
            const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(salesTrendCtx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Sales Revenue',
                        data: monthlyData.data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Region Chart
            const regionCtx = document.getElementById('regionChart').getContext('2d');
            if (charts.region) charts.region.destroy();
            
            const regionData = getRegionData();
            charts.region = new Chart(regionCtx, {
                type: 'doughnut',
                data: {
                    labels: regionData.labels,
                    datasets: [{
                        data: regionData.data,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Products Chart
            const productsCtx = document.getElementById('productsChart').getContext('2d');
            if (charts.products) charts.products.destroy();
            
            const productsChartData = getTopProductsData();
            charts.products = new Chart(productsCtx, {
                type: 'bar',
                data: {
                    labels: productsChartData.labels,
                    datasets: [{
                        label: 'Revenue',
                        data: productsChartData.data,
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Monthly Performance Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Sales Count',
                        data: monthlyData.counts,
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function getMonthlySalesData() {
            const monthlyData = {};
            salesData.forEach(sale => {
                const month = sale.sale_date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { revenue: 0, count: 0 };
                }
                monthlyData[month].revenue += sale.total_amount;
                monthlyData[month].count += 1;
            });

            const labels = Object.keys(monthlyData).sort();
            const data = labels.map(month => monthlyData[month].revenue * currencyRate[currentCurrency]);
            const counts = labels.map(month => monthlyData[month].count);

            return { labels, data, counts };
        }

        function getRegionData() {
            const regionData = {};
            salesData.forEach(sale => {
                regionData[sale.region] = (regionData[sale.region] || 0) + sale.total_amount;
            });

            return {
                labels: Object.keys(regionData),
                data: Object.values(regionData).map(amount => amount * currencyRate[currentCurrency])
            };
        }

        function getTopProductsData() {
            const productData = {};
            salesData.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    productData[product.name] = (productData[product.name] || 0) + sale.total_amount;
                }
            });

            const sorted = Object.entries(productData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            return {
                labels: sorted.map(([name]) => name),
                data: sorted.map(([,amount]) => amount * currencyRate[currentCurrency])
            };
        }

        // Profit & Loss functions
        function updateProfitLoss(kpiData = null) {
            if (!kpiData) {
                // Calculate from current data
                const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
                let totalCosts = salesData.reduce((sum, sale) => {
                    const product = productsData.find(p => p.id === sale.product_id);
                    const costPrice = product ? (product.cost_price || 0) : 0;
                    const quantity = sale.quantity || 0;
                    return sum + (costPrice * quantity);
                }, 0);
                
                // If no cost data, treat as 100% profit (no cost of goods sold)
                if (totalCosts === 0 && totalRevenue > 0) {
                    console.log('No cost data - treating as 100% profit scenario');
                    // Keep totalCosts as 0, which means gross profit = revenue
                }
                
                const grossProfit = totalRevenue - totalCosts;
                const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
                const netProfit = grossProfit - totalExpenses;
                const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;

                kpiData = {
                    total_revenue: totalRevenue,
                    total_costs: totalCosts,
                    net_profit: netProfit,
                    profit_margin: profitMargin
                };
            }

            const totalRevenue = kpiData.total_revenue || 0;
            const totalCosts = kpiData.total_costs || 0;
            
            // Calculate Gross Profit = Total Revenue - Cost of Goods Sold
            const grossProfit = totalRevenue - totalCosts;
            
            // Calculate Net Profit = Gross Profit - Expenses
            const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = grossProfit - totalExpenses;
            
            // Calculate profit margin based on revenue
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
            
            document.getElementById('plRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('plCosts').textContent = formatCurrency(totalCosts);
            document.getElementById('plProfit').textContent = formatCurrency(netProfit);
            document.getElementById('plMargin').textContent = `${profitMargin.toFixed(1)}%`;
            
            // Add visual indicators for negative values
            const profitElement = document.getElementById('plProfit');
            const marginElement = document.getElementById('plMargin');
            
            if (netProfit < 0) {
                profitElement.style.color = '#ef4444'; // Red for negative profit
            } else {
                profitElement.style.color = '#10b981'; // Green for positive profit
            }
            
            if (profitMargin < 0) {
                marginElement.style.color = '#ef4444'; // Red for negative margin
            } else {
                marginElement.style.color = '#10b981'; // Green for positive margin
            }
            
            // Update Gross Profit card (Revenue - COGS)
            document.getElementById('grossProfit').textContent = formatCurrency(grossProfit);

            // Update product profit table
            updateProductProfitTable();
        }

        function updateProductProfitTable() {
            const productProfits = {};
            
            salesData.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    if (!productProfits[product.name]) {
                        productProfits[product.name] = {
                            revenue: 0,
                            costs: 0,
                            quantity: 0
                        };
                    }
                    productProfits[product.name].revenue += sale.total_amount;
                    productProfits[product.name].costs += product.cost_price * sale.quantity;
                    productProfits[product.name].quantity += sale.quantity;
                }
            });

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Revenue</th>
                            <th>Costs</th>
                            <th>Profit</th>
                            <th>Margin</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(productProfits).forEach(([product, data]) => {
                const profit = data.revenue - data.costs;
                const margin = data.revenue > 0 ? (profit / data.revenue * 100) : 0;
                const marginColor = margin > 20 ? '#10b981' : margin > 10 ? '#f59e0b' : '#ef4444';

                tableHTML += `
                    <tr>
                        <td><strong>${product}</strong></td>
                        <td>${formatCurrency(data.revenue)}</td>
                        <td>${formatCurrency(data.costs)}</td>
                        <td>${formatCurrency(profit)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${margin.toFixed(1)}%</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('productProfitTable').innerHTML = tableHTML;
        }

        // Export functions
        function exportData() {
            document.getElementById('exportDialog').style.display = 'block';
        }

        function closeExportDialog() {
            document.getElementById('exportDialog').style.display = 'none';
        }

        function performExport() {
            const format = document.getElementById('exportFormat').value;
            const dataType = document.getElementById('exportDataType').value;
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;

            let data = [];
            let filename = '';

            switch (dataType) {
                case 'sales':
                    data = filteredSalesData.length > 0 ? filteredSalesData : salesData;
                    filename = 'sales_data';
                    break;
                case 'products':
                    data = productsData;
                    filename = 'products_data';
                    break;
                case 'analytics':
                    data = generateAnalyticsReport();
                    filename = 'analytics_report';
                    break;
                case 'profitloss':
                    data = generateProfitLossReport();
                    filename = 'profit_loss_report';
                    break;
            }

            // Apply date filter if specified
            if (startDate && endDate && (dataType === 'sales' || dataType === 'analytics')) {
                if (Array.isArray(data)) {
                    data = data.filter(item => {
                        const itemDate = new Date(item.sale_date || item.date);
                        return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
                    });
                }
            }

            if (format === 'csv') {
                exportToCSV(data, filename);
            } else if (format === 'json') {
                exportToJSON(data, filename);
            } else if (format === 'pdf') {
                exportToPDF(data, filename);
            }

            closeExportDialog();
            showNotification('ðŸ“Š Data exported successfully!', 'success');
        }

        function exportToCSV(data, filename) {
            if (data.length === 0) return;

            // Convert currency fields if data contains monetary values
            const convertedData = data.map(row => {
                const convertedRow = { ...row };
                // Convert common currency field names
                const currencyFields = ['total_amount', 'unit_price', 'cost_price', 'revenue', 'costs', 'profit', 'net_profit', 'average_sale'];
                currencyFields.forEach(field => {
                    if (convertedRow[field] && !isNaN(convertedRow[field])) {
                        convertedRow[field] = convertedRow[field] * currencyRate[currentCurrency];
                    }
                });
                return convertedRow;
            });

            const headers = Object.keys(convertedData[0]);
            const csvContent = [
                headers.join(','),
                ...convertedData.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');

            downloadFile(csvContent, `${filename}_${currentCurrency}.csv`, 'text/csv');
        }

        function exportToJSON(data, filename) {
            // Convert currency fields if data contains monetary values
            let convertedData = data;
            if (Array.isArray(data)) {
                convertedData = data.map(row => {
                    const convertedRow = { ...row };
                    // Convert common currency field names
                    const currencyFields = ['total_amount', 'unit_price', 'cost_price', 'revenue', 'costs', 'profit', 'net_profit', 'average_sale'];
                    currencyFields.forEach(field => {
                        if (convertedRow[field] && !isNaN(convertedRow[field])) {
                            convertedRow[field] = convertedRow[field] * currencyRate[currentCurrency];
                        }
                    });
                    return convertedRow;
                });
            } else if (typeof data === 'object') {
                // Handle single object (like report data)
                convertedData = { ...data };
                const currencyFields = ['revenue', 'costs', 'profit', 'net_profit', 'average_sale', 'total_revenue'];
                currencyFields.forEach(field => {
                    if (convertedData[field] && !isNaN(convertedData[field])) {
                        convertedData[field] = convertedData[field] * currencyRate[currentCurrency];
                    }
                });
            }
            
            const jsonContent = JSON.stringify(convertedData, null, 2);
            downloadFile(jsonContent, `${filename}_${currentCurrency}.json`, 'application/json');
        }

        function exportToPDF(data, filename) {
            // Simple PDF generation using browser print
            const printWindow = window.open('', '_blank');
            const content = generatePDFContent(data, filename);
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.print();
        }

        function generatePDFContent(data, filename) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${filename}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        h1 { color: #333; }
                    </style>
                </head>
                <body>
                    <h1>${filename.replace('_', ' ').toUpperCase()}</h1>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <p>Currency: ${currentCurrency}</p>
                    ${generateTableHTML(data)}
                </body>
                </html>
            `;
        }

        function generateTableHTML(data) {
            if (data.length === 0) return '<p>No data available</p>';

            const headers = Object.keys(data[0]);
            let html = '<table><thead><tr>';
            headers.forEach(header => {
                html += `<th>${header.replace('_', ' ').toUpperCase()}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function generateAnalyticsReport() {
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.total_amount, 0);
            const averageSale = totalRevenue / salesData.length;
            
            return {
                summary: {
                    total_revenue: totalRevenue * currencyRate[currentCurrency],
                    total_sales: salesData.length,
                    average_sale: averageSale * currencyRate[currentCurrency],
                    currency: currentCurrency,
                    currency_symbol: currentCurrency === 'USD' ? '$' : 'KSh'
                },
                monthly_data: getMonthlySalesData(),
                region_data: getRegionData(),
                top_products: getTopProductsData(),
                generated_at: new Date().toISOString()
            };
        }

        function generateProfitLossReport() {
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.total_amount, 0);
            const totalCosts = salesData.reduce((sum, sale) => {
                const product = productsData.find(p => p.id === sale.product_id);
                return sum + (product ? product.cost_price * sale.quantity : 0);
            }, 0);
            const netProfit = totalRevenue - totalCosts;
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;

            return {
                period: 'All Time',
                currency: currentCurrency,
                currency_symbol: currentCurrency === 'USD' ? '$' : 'KSh',
                revenue: totalRevenue * currencyRate[currentCurrency],
                costs: totalCosts * currencyRate[currentCurrency],
                net_profit: netProfit * currencyRate[currentCurrency],
                profit_margin: profitMargin,
                product_breakdown: updateProductProfitTable(),
                generated_at: new Date().toISOString()
            };
        }

        // Generate Report function
        function generateReport() {
            const reportData = generateProfitLossReport();
            const content = generatePDFContent([reportData], 'profit_loss_report');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.print();
            showNotification('ðŸ“„ Report generated successfully!', 'success');
        }

        // Generate Intelligent Report with Analysis and Recommendations
        function generateIntelligentReport() {
            if (salesData.length === 0) {
                showNotification('âš ï¸ No sales data available for analysis', 'warning');
                return;
            }

            const analysis = performIntelligentAnalysis();
            const content = generateIntelligentReportContent(analysis);
            
            // Open in new window for better viewing
            const reportWindow = window.open('', '_blank', 'width=1000,height=800');
            reportWindow.document.write(content);
            reportWindow.document.close();
            
            showNotification('ðŸ“Š Intelligent report generated successfully!', 'success');
        }

        function performIntelligentAnalysis() {
            const totalRevenue = salesData.reduce((sum, sale) => sum + sale.total_amount, 0);
            const totalSales = salesData.length;
            const averageSale = totalSales > 0 ? totalRevenue / totalSales : 0;
            
            // Calculate costs and profit
            const totalCosts = salesData.reduce((sum, sale) => {
                const product = productsData.find(p => p.id === sale.product_id);
                return sum + (product ? product.cost_price * sale.quantity : 0);
            }, 0);
            const grossProfit = totalRevenue - totalCosts;
            const profitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;

            // Time-based analysis
            const timeData = getTimeData(salesData);
            const months = Object.keys(timeData).sort();
            const latestMonth = months[months.length - 1];
            const previousMonth = months[months.length - 2];
            
            const latestRevenue = latestMonth ? timeData[latestMonth].revenue : 0;
            const previousRevenue = previousMonth ? timeData[previousMonth].revenue : 0;
            const revenueGrowth = previousRevenue > 0 ? ((latestRevenue - previousRevenue) / previousRevenue * 100) : 0;

            // Product performance analysis
            const productPerformance = {};
            salesData.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    if (!productPerformance[product.name]) {
                        productPerformance[product.name] = {
                            revenue: 0,
                            quantity: 0,
                            profit: 0
                        };
                    }
                    productPerformance[product.name].revenue += sale.total_amount;
                    productPerformance[product.name].quantity += sale.quantity;
                    productPerformance[product.name].profit += sale.total_amount - (product.cost_price * sale.quantity);
                }
            });

            const topProduct = Object.entries(productPerformance)
                .sort(([,a], [,b]) => b.revenue - a.revenue)[0];

            // Regional analysis
            const regionalPerformance = {};
            salesData.forEach(sale => {
                if (!regionalPerformance[sale.region]) {
                    regionalPerformance[sale.region] = { revenue: 0, sales: 0 };
                }
                regionalPerformance[sale.region].revenue += sale.total_amount;
                regionalPerformance[sale.region].sales += 1;
            });

            const topRegion = Object.entries(regionalPerformance)
                .sort(([,a], [,b]) => b.revenue - a.revenue)[0];

            // Generate insights and recommendations
            const insights = [];
            const recommendations = [];

            // Revenue insights
            if (revenueGrowth > 10) {
                insights.push(`ðŸ“ˆ Strong revenue growth of ${revenueGrowth.toFixed(1)}% compared to previous month`);
                recommendations.push("ðŸŽ¯ Continue current strategies to maintain growth momentum");
            } else if (revenueGrowth > 0) {
                insights.push(`ðŸ“Š Moderate revenue growth of ${revenueGrowth.toFixed(1)}% compared to previous month`);
                recommendations.push("ðŸš€ Consider expanding successful marketing campaigns");
            } else {
                insights.push(`ðŸ“‰ Revenue declined by ${Math.abs(revenueGrowth).toFixed(1)}% compared to previous month`);
                recommendations.push("âš ï¸ Review and adjust current strategies to reverse the decline");
            }

            // Profit margin insights
            if (profitMargin > 20) {
                insights.push(`ðŸ’° Excellent profit margin of ${profitMargin.toFixed(1)}%`);
                recommendations.push("ðŸ’¡ Consider reinvesting profits in growth opportunities");
            } else if (profitMargin > 10) {
                insights.push(`ðŸ“Š Healthy profit margin of ${profitMargin.toFixed(1)}%`);
                recommendations.push("ðŸŽ¯ Focus on optimizing operational costs");
            } else {
                insights.push(`âš ï¸ Low profit margin of ${profitMargin.toFixed(1)}%`);
                recommendations.push("ðŸ”§ Urgent need to reduce costs or increase prices");
            }

            // Product insights
            if (topProduct) {
                insights.push(`ðŸ† Top performer: ${topProduct[0]} with ${formatCurrency(topProduct[1].revenue)} revenue`);
                recommendations.push(`ðŸš€ Increase marketing focus on ${topProduct[0]} and similar products`);
            }

            // Regional insights
            if (topRegion) {
                insights.push(`ðŸŒ Top region: ${topRegion[0]} with ${formatCurrency(topRegion[1].revenue)} revenue`);
                recommendations.push(`ðŸ“ Expand operations in ${topRegion[0]} and similar markets`);
            }

            // Sales volume insights
            if (averageSale > 1000) {
                insights.push(`ðŸ’Ž High average sale value of ${formatCurrency(averageSale)}`);
                recommendations.push("ðŸŽ¯ Focus on high-value customer acquisition");
            } else {
                insights.push(`ðŸ“¦ Average sale value of ${formatCurrency(averageSale)}`);
                recommendations.push("ðŸ”„ Implement upselling strategies to increase transaction value");
            }

            return {
                summary: {
                    totalRevenue,
                    totalSales,
                    averageSale,
                    grossProfit,
                    profitMargin,
                    revenueGrowth,
                    currency: currentCurrency
                },
                topProduct: topProduct ? { name: topProduct[0], data: topProduct[1] } : null,
                topRegion: topRegion ? { name: topRegion[0], data: topRegion[1] } : null,
                insights,
                recommendations,
                generatedAt: new Date().toLocaleString()
            };
        }

        function generateIntelligentReportContent(analysis) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Intelligent Sales Analysis Report</title>
                    <style>
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            margin: 40px;
                            background: #f8fafc;
                            color: #2d3748;
                        }
                        .report-container {
                            max-width: 900px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 20px;
                            padding: 40px;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 40px;
                            padding-bottom: 30px;
                            border-bottom: 3px solid #667eea;
                        }
                        .report-header h1 {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            -webkit-background-clip: text;
                            background-clip: text;
                            -webkit-text-fill-color: transparent;
                            font-size: 2.5rem;
                            margin: 0;
                        }
                        .report-header p {
                            color: #6b7280;
                            margin: 10px 0 0 0;
                        }
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin-bottom: 40px;
                        }
                        .summary-card {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 25px;
                            border-radius: 15px;
                            text-align: center;
                        }
                        .summary-card h3 {
                            margin: 0 0 10px 0;
                            font-size: 0.9rem;
                            opacity: 0.9;
                        }
                        .summary-card .value {
                            font-size: 1.8rem;
                            font-weight: bold;
                            margin: 0;
                        }
                        .section {
                            margin-bottom: 40px;
                        }
                        .section h2 {
                            color: #2d3748;
                            border-bottom: 2px solid #e2e8f0;
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        .insights-list, .recommendations-list {
                            list-style: none;
                            padding: 0;
                        }
                        .insights-list li, .recommendations-list li {
                            background: #f7fafc;
                            margin: 10px 0;
                            padding: 15px 20px;
                            border-radius: 10px;
                            border-left: 4px solid #667eea;
                        }
                        .recommendations-list li {
                            border-left-color: #10b981;
                        }
                        .highlight-box {
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 15px;
                            margin: 20px 0;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 40px;
                            padding-top: 30px;
                            border-top: 1px solid #e2e8f0;
                            color: #6b7280;
                            font-size: 0.9rem;
                        }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <div class="report-header">
                            <h1>ðŸ“Š Intelligent Sales Analysis Report</h1>
                            <p>Comprehensive Analysis & Strategic Recommendations</p>
                        </div>

                        <div class="summary-grid">
                            <div class="summary-card">
                                <h3>Total Revenue</h3>
                                <p class="value">${formatCurrency(analysis.summary.totalRevenue)}</p>
                            </div>
                            <div class="summary-card">
                                <h3>Total Sales</h3>
                                <p class="value">${analysis.summary.totalSales}</p>
                            </div>
                            <div class="summary-card">
                                <h3>Average Sale</h3>
                                <p class="value">${formatCurrency(analysis.summary.averageSale)}</p>
                            </div>
                            <div class="summary-card">
                                <h3>Profit Margin</h3>
                                <p class="value">${analysis.summary.profitMargin.toFixed(1)}%</p>
                            </div>
                            <div class="summary-card">
                                <h3>Revenue Growth</h3>
                                <p class="value">${analysis.summary.revenueGrowth > 0 ? '+' : ''}${analysis.summary.revenueGrowth.toFixed(1)}%</p>
                            </div>
                        </div>

                        <div class="section">
                            <h2>ðŸ” Key Insights</h2>
                            <ul class="insights-list">
                                ${analysis.insights.map(insight => `<li>${insight}</li>`).join('')}
                            </ul>
                        </div>

                        <div class="section">
                            <h2>ðŸ’¡ Strategic Recommendations</h2>
                            <ul class="recommendations-list">
                                ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>

                        ${analysis.topProduct ? `
                        <div class="highlight-box">
                            <h3>ðŸ† Top Performing Product</h3>
                            <p><strong>${analysis.topProduct.name}</strong></p>
                            <p>Revenue: ${formatCurrency(analysis.topProduct.data.revenue)} | 
                               Quantity Sold: ${analysis.topProduct.data.quantity} | 
                               Profit: ${formatCurrency(analysis.topProduct.data.profit)}</p>
                        </div>
                        ` : ''}

                        ${analysis.topRegion ? `
                        <div class="highlight-box">
                            <h3>ðŸŒ Top Performing Region</h3>
                            <p><strong>${analysis.topRegion.name}</strong></p>
                            <p>Revenue: ${formatCurrency(analysis.topRegion.data.revenue)} | 
                               Sales Count: ${analysis.topRegion.data.sales}</p>
                        </div>
                        ` : ''}

                        <div class="footer">
                            <p>Report generated on ${analysis.generatedAt}</p>
                            <p>Currency: ${analysis.summary.currency} | Data Source: Sales Analytics Pro</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        // Edit and Delete Functions
        function editSale(id) {
            // Check authentication and permissions
            if (!currentUser) {
                showNotification('âŒ Please log in to edit sales', 'error');
                showLoginModal();
                return;
            }
            
            if (currentUser.role === 'viewer') {
                showNotification('âŒ Viewers cannot edit sales. Contact an admin or analyst.', 'error');
                return;
            }
            
            const sale = salesData.find(s => s.id === id);
            if (!sale) {
                showNotification('âŒ Sale not found', 'error');
                return;
            }

            // Pre-fill the add sale form with existing data
            document.getElementById('saleProductId').value = sale.product_id;
            document.getElementById('saleQuantity').value = sale.quantity;
            document.getElementById('saleUnitPrice').value = sale.unit_price;
            document.getElementById('saleTotalAmount').value = sale.total_amount;
            document.getElementById('saleCustomerName').value = sale.customer_name;
            
            // Parse region to set country and town
            if (sale.region && sale.region.includes(',')) {
                const [country, town] = sale.region.split(', ').map(s => s.trim());
                document.getElementById('saleCountry').value = country;
                loadTowns(); // Load towns for the country
                setTimeout(() => {
                    document.getElementById('saleTown').value = town;
                }, 100);
            } else {
                // Fallback for old format
                document.getElementById('saleCountry').value = sale.region || '';
                loadTowns();
            }
            
            document.getElementById('saleDate').value = sale.sale_date;

            // Change form title and button
            const modal = document.getElementById('addSaleModal');
            const title = modal.querySelector('h3');
            const submitBtn = modal.querySelector('button[type="submit"]');
            
            title.innerHTML = '<i class="fas fa-edit"></i> Edit Sale';
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Sale';
            submitBtn.onclick = () => updateSale(id);

            openModal('addSaleModal');
            showNotification('âœï¸ Sale loaded for editing', 'success');
        }

        async function updateSale(id) {
            const saleData = {
                product_id: parseInt(document.getElementById('saleProductId').value),
                quantity: parseInt(document.getElementById('saleQuantity').value),
                unit_price: parseFloat(document.getElementById('saleUnitPrice').value),
                total_amount: parseFloat(document.getElementById('saleTotalAmount').value),
                customer_name: document.getElementById('saleCustomerName').value,
                region: `${document.getElementById('saleCountry').value}, ${document.getElementById('saleTown').value}`,
                sale_date: document.getElementById('saleDate').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/sales/${id}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(saleData)
                });

                if (response.ok) {
                    // Reset form
                    document.getElementById('addSaleForm').reset();
                    closeModal('addSaleModal');
                    
                    // Reset form title and button
                    const modal = document.getElementById('addSaleModal');
                    const title = modal.querySelector('h3');
                    const submitBtn = modal.querySelector('button[type="submit"]');
                    title.innerHTML = '<i class="fas fa-plus"></i> Add New Sale';
                    submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Sale';
                    submitBtn.onclick = null;

                    // Refresh displays
                    await loadSalesData();
                    await loadKPIData();
                    updateProfitLoss();
                    
                    showNotification('âœ… Sale updated successfully!', 'success');
                } else {
                    throw new Error('Failed to update sale');
                }
            } catch (error) {
                showNotification('âŒ Failed to update sale', 'error');
            }
        }

        async function deleteSale(id) {
            // Check authentication and permissions
            if (!currentUser) {
                showNotification('âŒ Please log in to delete sales', 'error');
                showLoginModal();
                return;
            }
            
            if (currentUser.role !== 'admin') {
                showNotification('âŒ Only admins can delete sales', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this sale? This action cannot be undone.')) {
                try {
                    const response = await fetch(`${API_BASE}/api/sales/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    if (response.ok) {
                        // Refresh displays
                        await loadSalesData();
                        await loadKPIData();
                        updateProfitLoss();
                        
                        showNotification('âœ… Sale deleted successfully!', 'success');
                    } else {
                        throw new Error('Failed to delete sale');
                    }
                } catch (error) {
                    showNotification('âŒ Failed to delete sale', 'error');
                }
            }
        }

        function editProduct(id) {
            // Check authentication and permissions
            if (!currentUser) {
                showNotification('âŒ Please log in to edit products', 'error');
                showLoginModal();
                return;
            }
            
            if (currentUser.role === 'viewer') {
                showNotification('âŒ Viewers cannot edit products. Contact an admin or analyst.', 'error');
                return;
            }
            
            const product = productsData.find(p => p.id === id);
            if (!product) {
                showNotification('âŒ Product not found', 'error');
                return;
            }

            // Pre-fill the add product form with existing data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productUnitPrice').value = product.unit_price;
            document.getElementById('productCostPrice').value = product.cost_price;

            // Change form title and button
            const modal = document.getElementById('addProductModal');
            const title = modal.querySelector('h3');
            const submitBtn = modal.querySelector('button[type="submit"]');
            
            title.innerHTML = '<i class="fas fa-edit"></i> Edit Product';
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Product';
            submitBtn.onclick = () => updateProduct(id);

            openModal('addProductModal');
            showNotification('âœï¸ Product loaded for editing', 'success');
        }

        async function updateProduct(id) {
            const unitPrice = parseFloat(document.getElementById('productUnitPrice').value);
            const costPrice = parseFloat(document.getElementById('productCostPrice').value);
            const unitCurrency = document.getElementById('productUnitCurrency').value;
            const costCurrency = document.getElementById('productCostCurrency').value;
            
            // Convert to USD for storage
            const unitPriceUSD = unitCurrency === 'KES' ? unitPrice / currencyRate.KES : unitPrice;
            const costPriceUSD = costCurrency === 'KES' ? costPrice / currencyRate.KES : costPrice;
            
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                unit_price: unitPriceUSD,
                cost_price: costPriceUSD
            };

            try {
                const response = await fetch(`${API_BASE}/api/products/${id}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    // Reset form
                    document.getElementById('addProductForm').reset();
                    closeModal('addProductModal');
                    
                    // Reset form title and button
                    const modal = document.getElementById('addProductModal');
                    const title = modal.querySelector('h3');
                    const submitBtn = modal.querySelector('button[type="submit"]');
                    title.innerHTML = '<i class="fas fa-plus"></i> Add New Product';
                    submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Product';
                    submitBtn.onclick = null;

                    // Refresh displays
                    await loadProducts();
                    await loadSalesData();
                    await loadKPIData();
                    updateProfitLoss();
                    
                    showNotification('âœ… Product updated successfully!', 'success');
                } else {
                    throw new Error('Failed to update product');
                }
            } catch (error) {
                showNotification('âŒ Failed to update product', 'error');
            }
        }

        async function deleteProduct(id) {
            // Check authentication and permissions
            if (!currentUser) {
                showNotification('âŒ Please log in to delete products', 'error');
                showLoginModal();
                return;
            }
            
            if (currentUser.role !== 'admin') {
                showNotification('âŒ Only admins can delete products', 'error');
                return;
            }
            
            // Check if product is used in any sales
            const isUsedInSales = salesData.some(sale => sale.product_id === id);
            
            if (isUsedInSales) {
                showNotification('âŒ Cannot delete product that has sales records. Please delete related sales first.', 'error');
                return;
            }

            if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                try {
                    const response = await fetch(`${API_BASE}/api/products/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    if (response.ok) {
                        // Refresh displays
                        await loadProducts();
                        await loadSalesData();
                        await loadKPIData();
                        updateProfitLoss();
                        
                        showNotification('âœ… Product deleted successfully!', 'success');
                    } else {
                        throw new Error('Failed to delete product');
                    }
                } catch (error) {
                    showNotification('âŒ Failed to delete product', 'error');
                }
            }
        }

        // Import functions
        function importData() {
            document.getElementById('importDialog').style.display = 'block';
        }

        function closeImportDialog() {
            document.getElementById('importDialog').style.display = 'none';
        }

        function performImport() {
            const file = document.getElementById('importFile').files[0];
            const importType = document.getElementById('importType').value;
            const importCurrency = document.getElementById('importCurrency').value;
            const replaceData = document.getElementById('importReplaceData').checked;

            if (!file) {
                showNotification('âŒ Please select a file to import', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const content = e.target.result;
                    let data = [];

                    if (file.name.endsWith('.csv')) {
                        data = parseCSV(content);
                    } else if (file.name.endsWith('.json')) {
                        data = JSON.parse(content);
                    } else {
                        showNotification('âŒ Unsupported file format', 'error');
                        return;
                    }

                    // Process and import data
                    await processImportedData(data, importType, importCurrency, replaceData);
                    showNotification('âœ… Data imported and analyzed successfully!', 'success');
                    closeImportDialog();
                } catch (error) {
                    showNotification('âŒ Error processing file: ' + error.message, 'error');
                }
            };

            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }

            return data;
        }

        async function processImportedData(data, importType, importCurrency, replaceData) {
            if (importType === 'sales' || (importType === 'csv' && data[0] && data[0].customer_name)) {
                // Process sales data
                const salesData = data.map(row => ({
                    product_id: parseInt(row.product_id) || 1,
                    quantity: parseInt(row.quantity) || 1,
                    unit_price: parseFloat(row.unit_price) || 0,
                    total_amount: parseFloat(row.total_amount) || 0,
                    customer_name: row.customer_name || 'Unknown',
                    region: row.region || 'Unknown',
                    sale_date: row.sale_date || new Date().toISOString().split('T')[0]
                }));

                if (replaceData) {
                    // Clear existing data and add new
                    salesData.forEach(async (sale) => {
                        await fetch(`${API_BASE}/api/sales/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(sale)
                        });
                    });
                } else {
                    // Append new data
                    salesData.forEach(async (sale) => {
                        await fetch(`${API_BASE}/api/sales/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(sale)
                        });
                    });
                }

                await loadSalesData();
                await loadKPIData();
                updateProfitLoss();
                renderSalesTable();
            } else if (importType === 'products' || (importType === 'csv' && data[0] && data[0].name)) {
                // Process products data
                const importedProductsData = data.map(row => ({
                    name: row.name || 'Unknown Product',
                    category: row.category || 'General',
                    unit_price: parseFloat(row.unit_price) || 0,
                    cost_price: parseFloat(row.cost_price) || 0
                }));

                importedProductsData.forEach(async (product) => {
                    await fetch(`${API_BASE}/api/products/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(product)
                    });
                });

                await loadProducts();
                renderProductsTable();
            }
        }

        // Interactive chart filtering
        let currentFilters = {
            product: null,
            region: null,
            dateRange: null,
            category: null,
            customer: null
        };

        let currentTimePeriod = 'month';
        let currentChart1Type = 'region';
        let currentChart2Type = 'product';
        let currentPerformanceMetric = 'revenue';

        // Duplicate function removed - using the first definition

        // New filtering and data processing functions
        function getFilteredSalesData() {
            let filtered = salesData;

            if (currentFilters.product) {
                const product = productsData.find(p => p.name === currentFilters.product);
                if (product) {
                    filtered = filtered.filter(sale => sale.product_id === product.id);
                }
            }

            if (currentFilters.region) {
                filtered = filtered.filter(sale => sale.region === currentFilters.region);
            }

            if (currentFilters.category) {
                const categoryProducts = productsData.filter(p => p.category === currentFilters.category);
                const categoryProductIds = categoryProducts.map(p => p.id);
                filtered = filtered.filter(sale => categoryProductIds.includes(sale.product_id));
            }

            if (currentFilters.customer) {
                filtered = filtered.filter(sale => sale.customer_name === currentFilters.customer);
            }

            if (currentFilters.dateRange) {
                filtered = filtered.filter(sale => 
                    sale.sale_date.startsWith(currentFilters.dateRange)
                );
            }

            return filtered;
        }

        function getTimeBasedData(data, period) {
            const timeData = {};
            
            data.forEach(sale => {
                let timeKey;
                const date = new Date(sale.sale_date);
                
                switch (period) {
                    case 'day':
                        timeKey = sale.sale_date;
                        break;
                    case 'week':
                        const weekStart = new Date(date);
                        weekStart.setDate(date.getDate() - date.getDay());
                        timeKey = weekStart.toISOString().split('T')[0];
                        break;
                    case 'month':
                        timeKey = sale.sale_date.substring(0, 7);
                        break;
                    case 'year':
                        timeKey = sale.sale_date.substring(0, 4);
                        break;
                }
                
                if (!timeData[timeKey]) {
                    timeData[timeKey] = { revenue: 0, count: 0 };
                }
                timeData[timeKey].revenue += sale.total_amount || 0;
                timeData[timeKey].count += 1;
            });

            const labels = Object.keys(timeData).sort();
            const revenue = labels.map(key => timeData[key].revenue * currencyRate[currentCurrency]);
            const counts = labels.map(key => timeData[key].count);

            return { labels, revenue, counts };
        }

        function getChartData(data, type) {
            const chartData = {};
            
            data.forEach(sale => {
                let key;
                
                switch (type) {
                    case 'region':
                        key = sale.region || 'Unknown';
                        break;
                    case 'product':
                        const product = productsData.find(p => p.id === sale.product_id);
                        key = product ? product.name : `Product ID: ${sale.product_id}`;
                        break;
                    case 'category':
                        const product2 = productsData.find(p => p.id === sale.product_id);
                        key = product2 ? product2.category : 'Unknown Category';
                        break;
                    case 'customer':
                        key = sale.customer_name || 'Unknown Customer';
                        break;
                }
                
                chartData[key] = (chartData[key] || 0) + (sale.total_amount || 0);
            });

            const sorted = Object.entries(chartData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);

            return {
                labels: sorted.map(([key]) => key),
                data: sorted.map(([,amount]) => amount * currencyRate[currentCurrency])
            };
        }

        function getPerformanceData(data, metric) {
            const timeData = {};
            
            data.forEach(sale => {
                let timeKey;
                const date = new Date(sale.sale_date);
                
                switch (currentTimePeriod) {
                    case 'day':
                        timeKey = sale.sale_date;
                        break;
                    case 'week':
                        const weekStart = new Date(date);
                        weekStart.setDate(date.getDate() - date.getDay());
                        timeKey = weekStart.toISOString().split('T')[0];
                        break;
                    case 'month':
                        timeKey = sale.sale_date.substring(0, 7);
                        break;
                    case 'year':
                        timeKey = sale.sale_date.substring(0, 4);
                        break;
                }
                
                if (!timeData[timeKey]) {
                    timeData[timeKey] = { revenue: 0, quantity: 0, transactions: 0, profit: 0 };
                }
                
                timeData[timeKey].revenue += sale.total_amount || 0;
                timeData[timeKey].quantity += sale.quantity || 0;
                timeData[timeKey].transactions += 1;
                
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    const profit = (sale.total_amount || 0) - ((product.cost_price || 0) * (sale.quantity || 0));
                    timeData[timeKey].profit += profit;
                }
            });

            const labels = Object.keys(timeData).sort();
            const values = labels.map(key => {
                const value = timeData[key][metric];
                return metric === 'revenue' || metric === 'profit' ? value * currencyRate[currentCurrency] : value;
            });

            return { labels, data: values };
        }

        function updateChartTitle(elementId, type) {
            const titles = {
                region: 'Revenue by Region',
                product: 'Top Products',
                category: 'Revenue by Category',
                customer: 'Top Customers',
                revenue: 'Revenue Performance',
                quantity: 'Quantity Performance',
                transactions: 'Transaction Performance',
                profit: 'Profit Performance'
            };
            
            const icons = {
                region: 'fas fa-globe',
                product: 'fas fa-box',
                category: 'fas fa-tags',
                customer: 'fas fa-users',
                revenue: 'fas fa-dollar-sign',
                quantity: 'fas fa-shopping-cart',
                transactions: 'fas fa-receipt',
                profit: 'fas fa-chart-line'
            };
            
            document.getElementById(elementId).innerHTML = 
                `<i class="${icons[type]}"></i> ${titles[type]}`;
        }

        function getPerformanceLabel(metric) {
            const labels = {
                revenue: 'Revenue',
                quantity: 'Quantity',
                transactions: 'Transactions',
                profit: 'Profit'
            };
            return labels[metric] || 'Value';
        }

        function applyFilter(type, value) {
            // Clear other filters of the same type
            Object.keys(currentFilters).forEach(key => {
                if (key === type) {
                    currentFilters[key] = value;
                }
            });
            
            updateFilteredCharts();
            updateActiveFilters();
            showNotification(`ðŸ” Filtered by ${type}: ${value}`, 'success');
        }

        function filterByDateRange(timeLabel) {
            currentFilters.dateRange = timeLabel;
            updateFilteredCharts();
            updateActiveFilters();
            showNotification(`ðŸ” Filtered by ${currentTimePeriod}: ${timeLabel}`, 'success');
        }

        function animateChartUpdate() {
            // Add a subtle animation effect when charts update
            const chartCards = document.querySelectorAll('.analytics-card');
            chartCards.forEach(card => {
                card.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    card.style.transform = 'scale(1)';
                }, 150);
            });
        }

        function updateTimePeriod() {
            currentTimePeriod = document.getElementById('timePeriod').value;
            
            // Get the currently active tab and recreate its charts
            const activeTab = document.querySelector('.analytics-tab-content.active');
            if (activeTab) {
                const tabId = activeTab.id;
                const tabName = tabId.replace('Tab', '');
                loadTabCharts(tabName);
            }
            
            showNotification(`ðŸ“… Time period changed to ${currentTimePeriod}`, 'success');
        }

        function updateChartTypes() {
            currentChart1Type = document.getElementById('chart1Type').value;
            currentChart2Type = document.getElementById('chart2Type').value;
            currentPerformanceMetric = document.getElementById('performanceMetric').value;
            
            // Get the currently active tab and recreate its charts
            const activeTab = document.querySelector('.analytics-tab-content.active');
            if (activeTab) {
                const tabId = activeTab.id;
                const tabName = tabId.replace('Tab', '');
                loadTabCharts(tabName);
            }
            
            showNotification('ðŸ“Š Chart types updated', 'success');
        }

        function clearFilters() {
            currentFilters = { product: null, region: null, dateRange: null, category: null, customer: null };
            updateFilteredCharts();
            updateActiveFilters();
            showNotification('ðŸ”„ Filters cleared', 'success');
        }

        function updateFilteredCharts() {
            // Recreate all charts with filtered data
            createAnalyticsCharts();
            
            // Update KPI cards with filtered data
            updateFilteredKPIs();
            
            // Update all dashboard components
            updateDashboardComponents();
        }

        function updateFilteredKPIs() {
            const filteredSales = getFilteredSalesData();
            
            // Update KPI cards with filtered data
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
            const totalSales = filteredSales.length;
            const averageSale = totalSales > 0 ? totalRevenue / totalSales : 0;
            const totalCosts = filteredSales.reduce((sum, sale) => {
                const product = productsData.find(p => p.id === sale.product_id);
                return sum + ((product ? product.cost_price : 0) * (sale.quantity || 0));
            }, 0);
            const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalCosts) / totalRevenue * 100) : 0;

            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('averageSale').textContent = formatCurrency(averageSale);
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
        }

        function updateDashboardComponents() {
            const filteredSales = getFilteredSalesData();
            
            // Update sales table with filtered data
            renderSalesTable(filteredSales);
            
            // Update profit & loss section
            updateProfitLossFromFilteredData(filteredSales);
            
            // Update any other dashboard components that should respond to filters
            updateFilteredDataTables();
        }

        function updateProfitLossFromFilteredData(filteredSales) {
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
            const totalCosts = filteredSales.reduce((sum, sale) => {
                const product = productsData.find(p => p.id === sale.product_id);
                return sum + ((product ? product.cost_price : 0) * (sale.quantity || 0));
            }, 0);
            // Calculate Gross Profit = Total Revenue - Cost of Goods Sold
            const grossProfit = totalRevenue - totalCosts;
            
            // Calculate Net Profit = Gross Profit - Expenses
            const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = grossProfit - totalExpenses;
            
            // Calculate profit margin based on revenue
            const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;

            document.getElementById('plRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('plCosts').textContent = formatCurrency(totalCosts);
            document.getElementById('plProfit').textContent = formatCurrency(netProfit);
            document.getElementById('plMargin').textContent = `${profitMargin.toFixed(1)}%`;
            
            // Update Gross Profit card (Revenue - COGS)
            document.getElementById('grossProfit').textContent = formatCurrency(grossProfit);

            // Update product profit table with filtered data
            updateProductProfitTableFromFilteredData(filteredSales);
        }

        function updateProductProfitTableFromFilteredData(filteredSales) {
            const productProfits = {};
            
            filteredSales.forEach(sale => {
                const product = productsData.find(p => p.id === sale.product_id);
                if (product) {
                    if (!productProfits[product.name]) {
                        productProfits[product.name] = {
                            revenue: 0,
                            costs: 0,
                            quantity: 0
                        };
                    }
                    productProfits[product.name].revenue += sale.total_amount;
                    productProfits[product.name].costs += product.cost_price * sale.quantity;
                    productProfits[product.name].quantity += sale.quantity;
                }
            });

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Revenue</th>
                            <th>Costs</th>
                            <th>Profit</th>
                            <th>Margin</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(productProfits).forEach(([product, data]) => {
                const profit = data.revenue - data.costs;
                const margin = data.revenue > 0 ? (profit / data.revenue * 100) : 0;
                const marginColor = margin > 20 ? '#10b981' : margin > 10 ? '#f59e0b' : '#ef4444';

                tableHTML += `
                    <tr>
                        <td><strong>${product}</strong></td>
                        <td>${formatCurrency(data.revenue)}</td>
                        <td>${formatCurrency(data.costs)}</td>
                        <td>${formatCurrency(profit)}</td>
                        <td style="color: ${marginColor}; font-weight: bold;">${margin.toFixed(1)}%</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('productProfitTable').innerHTML = tableHTML;
        }

        function updateFilteredDataTables() {
            // Update any other tables or components that should respond to filters
            const filteredSales = getFilteredSalesData();
            
            // Update sales data table if it exists
            if (typeof renderSalesTable === 'function') {
                renderSalesTable(filteredSales);
            }
        }

        // Initialize analytics charts
        function initializeAnalyticsCharts() {
            try {
                console.log('ðŸ“Š Initializing analytics charts...');
                
                // Initialize all chart types
                initializeNetProfitVsExpensesChart();
                initializeGrossProfitVsCostChart();
                initializeCostToRevenueChart();
                initializeProfitMarginTrendChart();
                initializeSalesPerformanceChart();
                initializeRevenueDistributionChart();
                
                console.log('âœ… All analytics charts initialized successfully');
            } catch (error) {
                console.error('âŒ Error initializing analytics charts:', error);
                showNotification('âŒ Error loading analytics charts: ' + error.message, 'error');
            }
        }

        // Individual chart initialization functions
        function initializeNetProfitVsExpensesChart() {
            const ctx = document.getElementById('netProfitVsExpensesChart');
            if (!ctx) return;
            
            const data = {
                labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                datasets: [{
                    label: 'Net Profit',
                    data: [15000, 18000, 22000, 25000],
                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2
                }, {
                    label: 'Expenses',
                    data: [12000, 14000, 16000, 18000],
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2
                }]
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Net Profit vs Expenses'
                        }
                    }
                }
            });
        }

        function initializeGrossProfitVsCostChart() {
            const ctx = document.getElementById('grossProfitVsCostChart');
            if (!ctx) return;
            
            const data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Gross Profit',
                    data: [20000, 22000, 25000, 28000, 30000, 32000],
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Cost',
                    data: [15000, 16000, 18000, 20000, 22000, 24000],
                    borderColor: 'rgba(245, 158, 11, 1)',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Gross Profit vs Cost Trend'
                        }
                    }
                }
            });
        }

        function initializeCostToRevenueChart() {
            const ctx = document.getElementById('costToRevenueChart');
            if (!ctx) return;
            
            const data = {
                labels: ['Direct Costs', 'Operating Costs', 'Marketing', 'Admin', 'Other'],
                datasets: [{
                    label: 'Cost to Revenue Ratio',
                    data: [65, 15, 10, 5, 5],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(168, 85, 247, 0.8)'
                    ]
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cost to Revenue Distribution'
                        }
                    }
                }
            });
        }

        function initializeProfitMarginTrendChart() {
            const ctx = document.getElementById('profitMarginTrendChart');
            if (!ctx) return;
            
            const data = {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Profit Margin %',
                    data: [25, 28, 32, 35],
                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2
                }]
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Profit Margin Trend'
                        }
                    }
                }
            });
        }

        function initializeSalesPerformanceChart() {
            const ctx = document.getElementById('salesPerformanceChart');
            if (!ctx) return;
            
            const data = {
                datasets: [{
                    label: 'Sales Performance',
                    data: [
                        {x: 10, y: 1000},
                        {x: 15, y: 1500},
                        {x: 20, y: 2000},
                        {x: 25, y: 2500},
                        {x: 30, y: 3000}
                    ],
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)'
                }]
            };
            
            new Chart(ctx, {
                type: 'scatter',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sales Performance Scatter Plot'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Revenue'
                            }
                        }
                    }
                }
            });
        }

        function initializeRevenueDistributionChart() {
            const ctx = document.getElementById('revenueDistributionChart');
            if (!ctx) return;
            
            const data = {
                labels: ['$0-1000', '$1000-2000', '$2000-3000', '$3000-4000', '$4000+'],
                datasets: [{
                    label: 'Revenue Distribution',
                    data: [5, 12, 8, 6, 3],
                    backgroundColor: 'rgba(168, 85, 247, 0.6)',
                    borderColor: 'rgba(168, 85, 247, 1)',
                    borderWidth: 1
                }]
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Revenue Distribution Histogram'
                        }
                    }
                }
            });
        }

        // Show analytics panel
        function showAnalytics() {
            const panel = document.getElementById('analyticsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            
            if (panel.style.display === 'block') {
                // Ensure we have data before showing charts
                if (salesData.length === 0) {
                    showNotification('âš ï¸ No sales data available. Please add some sales or refresh data.', 'warning');
                    return;
                }

                // Initialize all analytics charts
                setTimeout(() => {
                    initializeAnalyticsCharts();
                }, 100);
                
                // Ensure overview tab is active by default
                showAnalyticsTab('overview');
                updateActiveFilters();
                showNotification('ðŸ“Š Analytics panel opened! Click on any chart element to filter data.', 'success');
            }
        }

        // Admin Panel Functions
        function showAdminPanel() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            
            if (panel.style.display === 'block') {
                loadAdminData();
            }
        }

        function showAdminTab(tabName) {
            // Hide all admin tab contents
            const tabContents = document.querySelectorAll('.admin-tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all admin tab buttons
            const tabButtons = document.querySelectorAll('.admin-tabs .tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        async function loadAdminData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/confidential`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateAdminData(data);
                } else {
                    showNotification('âŒ Failed to load admin data', 'error');
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
                showNotification('âŒ Error loading admin data', 'error');
            }
        }

        function updateAdminData(data) {
            // Update Financial Reports
            if (data.confidential_financials) {
                const financial = data.confidential_financials;
                // Convert from USD base to current currency
                document.getElementById('monthlyRevenue').textContent = formatCurrency(financial.monthly_revenue);
                document.getElementById('monthlyExpenses').textContent = formatCurrency(financial.monthly_expenses);
                document.getElementById('netProfit').textContent = formatCurrency(financial.net_profit);
                document.getElementById('profitMargin').textContent = (financial.profit_margin * 100).toFixed(1) + '%';
            }

            // Update Employee Performance
            if (data.employee_performance) {
                const employee = data.employee_performance;
                
                // Top Performers
                const topPerformersContainer = document.getElementById('topPerformers');
                topPerformersContainer.innerHTML = '';
                employee.top_performers.forEach(performer => {
                    const item = document.createElement('div');
                    item.className = 'employee-item';
                    item.innerHTML = `<span class="employee-name">${performer}</span>`;
                    topPerformersContainer.appendChild(item);
                });

                // Sales Targets
                const salesTargetsContainer = document.getElementById('salesTargets');
                salesTargetsContainer.innerHTML = '';
                Object.entries(employee.sales_targets).forEach(([name, target]) => {
                    const item = document.createElement('div');
                    item.className = 'target-item';
                    item.innerHTML = `<span class="target-name">${name}</span><span class="target-value">${formatCurrency(target)}</span>`;
                    salesTargetsContainer.appendChild(item);
                });

                // Commission Rates
                const commissionContainer = document.getElementById('commissionRates');
                commissionContainer.innerHTML = '';
                Object.entries(employee.commission_rates).forEach(([name, rate]) => {
                    const item = document.createElement('div');
                    item.className = 'commission-item';
                    item.innerHTML = `<span class="commission-name">${name}</span><span class="commission-value">${(rate * 100).toFixed(1)}%</span>`;
                    commissionContainer.appendChild(item);
                });
            }

            // Update Market Analysis
            if (data.market_analysis) {
                const market = data.market_analysis;
                document.getElementById('marketShare').textContent = (market.market_share * 100).toFixed(1) + '%';
                document.getElementById('growthRate').textContent = (market.growth_rate * 100).toFixed(1) + '%';
                
                // Competitor Pricing
                const pricingContainer = document.getElementById('competitorPricing');
                pricingContainer.innerHTML = '';
                Object.entries(market.competitor_pricing).forEach(([product, price]) => {
                    const item = document.createElement('div');
                    item.className = 'pricing-item';
                    item.innerHTML = `<span class="product-name">${product}</span><span class="product-price">${formatCurrency(price)}</span>`;
                    pricingContainer.appendChild(item);
                });
            }
        }

        function updateActiveFilters() {
            const filterChipsDiv = document.getElementById('filterChips');
            if (!filterChipsDiv) return;
            
            filterChipsDiv.innerHTML = '';
            
            if (Object.keys(activeFilters).length === 0) {
                filterChipsDiv.innerHTML = '<span class="filter-info">Click on any chart element to filter data across all visualizations</span>';
                document.getElementById('clearFiltersBtn').style.display = 'none';
                return;
            }
            
            Object.entries(activeFilters).forEach(([key, value]) => {
                const chip = document.createElement('span');
                chip.className = 'filter-chip';
                chip.innerHTML = `${key}: ${value} <span class="remove" onclick="removeFilter('${key}')">Ã—</span>`;
                filterChipsDiv.appendChild(chip);
            });
            
            document.getElementById('clearFiltersBtn').style.display = 'inline-block';
        }

        function clearFilter(filterType) {
            currentFilters[filterType] = null;
            updateFilteredCharts();
            updateActiveFilters();
        }

        // Cross-filtering functions
        function addFilter(filterType, filterValue) {
            activeFilters[filterType] = filterValue;
            updateActiveFilters();
            applyCrossFilters();
            showNotification(`ðŸ” Filtered by ${filterType}: ${filterValue}`, 'info');
        }

        function removeFilter(filterType) {
            delete activeFilters[filterType];
            updateActiveFilters();
            applyCrossFilters();
        }

        function clearAllFilters() {
            activeFilters = {};
            updateActiveFilters();
            applyCrossFilters();
            showNotification('ðŸ§¹ All filters cleared', 'success');
        }

        function applyCrossFilters() {
            // Filter sales data based on active filters
            filteredSalesData = salesData.filter(sale => {
                return Object.entries(activeFilters).every(([filterType, filterValue]) => {
                    switch (filterType) {
                        case 'brand':
                            const product = productsData.find(p => p.id === sale.product_id);
                            return product && product.brand === filterValue;
                        case 'region':
                            return sale.region === filterValue;
                        case 'month':
                            const saleMonth = new Date(sale.sale_date).toLocaleDateString('en-US', { month: 'long' });
                            return saleMonth === filterValue;
                        case 'year':
                            const saleYear = new Date(sale.sale_date).getFullYear().toString();
                            return saleYear === filterValue;
                        default:
                            return true;
                    }
                });
            });

            // Get the currently active tab and recreate its charts
            const activeTab = document.querySelector('.analytics-tab-content.active');
            if (activeTab) {
                const tabId = activeTab.id;
                const tabName = tabId.replace('Tab', '');
                loadTabCharts(tabName);
            }
            
            // Update KPI cards with filtered data
            updateKPIsWithFilteredData();
        }

        function updateKPIsWithFilteredData() {
            if (filteredSalesData.length === 0) {
                filteredSalesData = salesData; // Show all data if no filters
            }

            const totalRevenue = filteredSalesData.reduce((sum, sale) => sum + sale.total_amount, 0);
            const totalSales = filteredSalesData.length;
            const averageSale = totalSales > 0 ? totalRevenue / totalSales : 0;
            
            // Update KPI displays
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('averageSale').textContent = formatCurrency(averageSale);
        }

        // Authentication Functions
        let currentUser = null;
        let authToken = null;

        // Check if user is already logged in
        function checkAuthStatus() {
            const savedUser = localStorage.getItem('user');
            const savedToken = localStorage.getItem('authToken');
            
            if (savedUser && savedToken) {
                currentUser = JSON.parse(savedUser);
                authToken = savedToken;
                updateAuthUI(true);
            } else {
                updateAuthUI(false);
            }
        }

        // Update authentication UI
        function updateAuthUI(isLoggedIn) {
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            const userRole = document.getElementById('userRole');
            const loginPrompt = document.getElementById('loginPrompt');
            const mainDashboard = document.getElementById('mainDashboard');
            const sidebar = document.getElementById('sidebar');
            const navMenu = document.querySelector('.nav-menu');

            if (isLoggedIn && currentUser) {
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                loginPrompt.style.display = 'none';
                mainDashboard.classList.remove('auth-required');
                sidebar.classList.remove('auth-required');
                if (navMenu) navMenu.classList.remove('hidden');
                
                userName.textContent = currentUser.name || currentUser.email;
                userAvatar.textContent = (currentUser.name || currentUser.email).charAt(0).toUpperCase();
                
                // Update role badge
                userRole.textContent = currentUser.role || 'user';
                userRole.className = `role-badge role-${currentUser.role || 'viewer'}`;
                
                // Apply role-based permissions
                applyRoleBasedPermissions(currentUser.role);
            } else {
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                loginPrompt.style.display = 'block';
                mainDashboard.classList.add('auth-required');
                sidebar.classList.add('auth-required');
                if (navMenu) navMenu.classList.add('hidden');
                // Show login modal when not authenticated
                showLoginModal();
            }
        }


        // Apply role-based permissions
        function applyRoleBasedPermissions(role) {
            console.log('Applying role-based permissions for role:', role);
            // Enable/disable features based on role
            const editButtons = document.querySelectorAll('.edit-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');
            const addButtons = document.querySelectorAll('.add-btn');
            const userManagementBtn = document.getElementById('userManagementBtn');
            
            console.log('User Management button found:', userManagementBtn);
            
            // Admin: Full access
            if (role === 'admin') {
                editButtons.forEach(btn => btn.disabled = false);
                deleteButtons.forEach(btn => btn.disabled = false);
                addButtons.forEach(btn => btn.disabled = false);
                
                // Show admin buttons in header
                const adminDataBtn = document.getElementById('adminDataBtn');
                const userManagementBtn = document.getElementById('userManagementBtn');
                if (adminDataBtn) adminDataBtn.style.display = 'inline-flex';
                if (userManagementBtn) userManagementBtn.style.display = 'inline-flex';
            }
            // Analyst: Can edit and add, but not delete
            else if (role === 'analyst') {
                editButtons.forEach(btn => btn.disabled = false);
                deleteButtons.forEach(btn => btn.disabled = true);
                addButtons.forEach(btn => btn.disabled = false);
                if (userManagementBtn) userManagementBtn.style.display = 'none';
            }
            // Viewer: Read-only access
            else if (role === 'viewer') {
                editButtons.forEach(btn => btn.disabled = true);
                deleteButtons.forEach(btn => btn.disabled = true);
                addButtons.forEach(btn => btn.disabled = true);
                if (userManagementBtn) userManagementBtn.style.display = 'none';
            }
            // Default: Hide admin buttons for non-admin users
            else {
                const adminDataBtn = document.getElementById('adminDataBtn');
                const userManagementBtn = document.getElementById('userManagementBtn');
                if (adminDataBtn) adminDataBtn.style.display = 'none';
                if (userManagementBtn) userManagementBtn.style.display = 'none';
            }
        }

        // Show login modal
        function showLoginModal() {
            console.log('showLoginModal called');
            const modal = document.getElementById('loginModal');
            console.log('Modal element:', modal);
            if (modal) {
                console.log('Adding active class');
                modal.classList.add('active');
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                modal.style.zIndex = '1000';
                document.body.style.overflow = 'hidden';
                
                // Focus on email input
                setTimeout(() => {
                    const emailInput = document.getElementById('loginEmail');
                    if (emailInput) {
                        emailInput.focus();
                    }
                }, 300);
            } else {
                console.error('Login modal not found!');
            }
        }

        // Hide login modal
        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }


        // Toggle password visibility
        function togglePassword() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = document.getElementById('loginSubmit');
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
            
            try {
                // Simulate API call (replace with actual API call)
                const response = await simulateLogin(email, password);
                
                if (response.success) {
                    currentUser = response.user;
                    authToken = response.token;
                    
                    // Save to localStorage
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    localStorage.setItem('authToken', authToken);
                    
                    // Update UI
                    updateAuthUI(true);
                    
                    // Hide login modal immediately
                    hideLoginModal();
                    
                    // Also hide any login prompt overlays
                    const loginPrompt = document.getElementById('loginPrompt');
                    if (loginPrompt) {
                        loginPrompt.style.display = 'none';
                    }
                    
                    // Load dashboard data after successful login
                    await loadKPIData();
                    await loadSalesData();
                    await loadProducts();
                    setTodayDate();
                    syncProductData();
                    
                    // Ensure KPIs are calculated from local data
                    updateKPIsFromLocalData();
                    
                    // Show success message
                    showNotification('Login successful! Welcome back, ' + currentUser.name, 'success');
                    
                    // Clear form
                    document.getElementById('loginForm').reset();
                } else {
                    showNotification(response.error || 'Login failed. Please check your credentials.', 'error');
                }
            } catch (error) {
                showNotification('An error occurred during login. Please try again.', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        }

        // Helper function to get auth headers
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return headers;
        }

        // Real login API call
        async function simulateLogin(email, password) {
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok && data.access_token) {
                    // Create user object from the login email
                    const userRole = email.includes('admin') ? 'admin' : 
                                   email.includes('analyst') ? 'analyst' : 'viewer';
                    const userName = email.split('@')[0].charAt(0).toUpperCase() + 
                                   email.split('@')[0].slice(1);
                    
                    return {
                        success: true,
                        user: {
                            id: Math.random().toString(36).substr(2, 9),
                            name: userName,
                            email: email,
                            role: userRole
                        },
                        token: data.access_token
                    };
                } else {
                    return {
                        success: false,
                        error: data.detail || 'Login failed'
                    };
                }
            } catch (error) {
                console.error('Login error:', error);
                return {
                    success: false,
                    error: 'Network error. Please check if the server is running.'
                };
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear stored data
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
                
                // Reset variables
                currentUser = null;
                authToken = null;
                
                // Update UI
                updateAuthUI(false);
                
                // Show logout message
                showNotification('You have been logged out successfully.', 'info');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('loginModal');
            if (event.target === modal) {
                hideLoginModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hideLoginModal();
            }
        });

        // Expenses Calculator Functions

        function showExpensesCalculator() {
            if (!currentUser) {
                showNotification('âŒ Please log in to use expenses calculator', 'error');
                showLoginModal();
                return;
            }
            
            const modal = document.getElementById('expensesModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Set today's date
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        function hideExpensesCalculator() {
            const modal = document.getElementById('expensesModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function calculateExpenses(event) {
            event.preventDefault();
            
            const expenseType = document.getElementById('expenseType').value;
            const expenseAmount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseDescription = document.getElementById('expenseDescription').value;
            const expenseDate = document.getElementById('expenseDate').value;
            
            const expense = {
                id: Date.now(),
                type: expenseType,
                amount: expenseAmount,
                description: expenseDescription,
                date: expenseDate
            };
            
            expensesData.push(expense);
            
            // Update expenses summary
            updateExpensesSummary();
            
            // Clear form
            document.getElementById('expensesForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            showNotification('âœ… Expense added successfully!', 'success');
        }

        function updateExpensesSummary() {
            const summaryDiv = document.getElementById('expensesSummary');
            const expensesListDiv = document.getElementById('expensesList');
            const totalExpensesSpan = document.getElementById('totalExpenses');
            const totalExpensesDisplay = document.getElementById('totalExpensesDisplay');
            
            // Calculate total
            const total = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            
            // Update expenses card display with negative value handling
            if (totalExpensesDisplay) {
                totalExpensesDisplay.textContent = formatCurrency(total);
                // Add visual indicator for negative values
                if (total < 0) {
                    totalExpensesDisplay.style.color = '#ef4444'; // Red for negative
                } else {
                    totalExpensesDisplay.style.color = ''; // Reset to default
                }
            }
            
            if (expensesData.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }
            
            summaryDiv.style.display = 'block';
            totalExpensesSpan.textContent = formatCurrency(total);
            
            // Add visual indicator for negative total
            if (total < 0) {
                totalExpensesSpan.style.color = '#ef4444';
            } else {
                totalExpensesSpan.style.color = '';
            }
            
            // Update expenses list with proper table structure
            expensesListDiv.innerHTML = `
                <div style="overflow-x: auto; margin-bottom: 15px;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <thead style="background: #f3f4f6;">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Description</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Type</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Date</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Amount</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${expensesData.map(expense => `
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    <td style="padding: 12px; color: #374151; font-weight: 500;">${expense.description}</td>
                                    <td style="padding: 12px; color: #6b7280; text-transform: capitalize;">${expense.type}</td>
                                    <td style="padding: 12px; color: #6b7280;">${expense.date}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${expense.amount < 0 ? '#ef4444' : '#059669'}">${formatCurrency(expense.amount)}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button onclick="removeExpense(${expense.id})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Statistics -->
                <div style="padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #374151; font-size: 1.1rem;">Total Expenses:</strong>
                        <strong id="totalExpenses" style="font-size: 1.2rem; color: ${total < 0 ? '#ef4444' : '#059669'}">${formatCurrency(total)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: #6b7280;">Number of Expenses:</span>
                        <span id="expenseCount" style="font-weight: 600;">${expensesData.length}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #6b7280;">Average per Expense:</span>
                        <span id="averageExpense" style="font-weight: 600;">${expensesData.length > 0 ? formatCurrency(total / expensesData.length) : formatCurrency(0)}</span>
                    </div>
                </div>
            `;
            
            // Update profit calculations with negative value handling
            updateProfitWithExpenses();
        }

        function removeExpense(expenseId) {
            expensesData = expensesData.filter(expense => expense.id !== expenseId);
            updateExpensesSummary();
            showNotification('âœ… Expense removed successfully!', 'success');
        }
        
        function updateProfitWithExpenses() {
            // Calculate total expenses
            const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            
            // Get current revenue and costs from displayed values
            const revenueElement = document.getElementById('plRevenue');
            const costsElement = document.getElementById('plCosts');
            const currentRevenue = parseFloat(revenueElement.textContent.replace(/[^0-9.-]+/g, ''));
            const currentCosts = parseFloat(costsElement.textContent.replace(/[^0-9.-]+/g, ''));
            
            // Calculate Gross Profit = Total Revenue - Cost of Goods Sold
            const grossProfit = currentRevenue - currentCosts;
            
            // Calculate Net Profit = Gross Profit - All Expenses
            const netProfit = grossProfit - totalExpenses;
            
            // Update Gross Profit display
            const grossProfitElement = document.getElementById('grossProfit');
            if (grossProfitElement) {
                grossProfitElement.textContent = formatCurrency(grossProfit);
                // Add visual indicator for negative gross profit
                if (grossProfit < 0) {
                    grossProfitElement.style.color = '#ef4444'; // Red for negative
                } else {
                    grossProfitElement.style.color = ''; // Reset to default
                }
            }
            
            // Update Net Profit display
            const profitElement = document.getElementById('plProfit');
            if (profitElement) {
                profitElement.textContent = formatCurrency(netProfit);
                // Add visual indicator for negative profit
                if (netProfit < 0) {
                    profitElement.style.color = '#ef4444'; // Red for negative
                } else {
                    profitElement.style.color = ''; // Reset to default
                }
            }
            
            // Update profit margin (based on revenue)
            const marginElement = document.getElementById('plMargin');
            if (marginElement && currentRevenue > 0) {
                const profitMargin = (netProfit / currentRevenue) * 100;
                marginElement.textContent = `${profitMargin.toFixed(1)}%`;
                
                // Add visual indicator for negative margin
                if (profitMargin < 0) {
                    marginElement.style.color = '#ef4444'; // Red for negative
                } else {
                    marginElement.style.color = ''; // Reset to default
                }
            }
        }

        // Refresh all data function
        async function refreshAllData() {
            if (!currentUser) {
                showNotification('âŒ Please log in to refresh data', 'error');
                showLoginModal();
                return;
            }
            
            const refreshBtn = document.querySelector('.refresh-btn');
            const icon = refreshBtn.querySelector('i');
            
            // Show loading state
            refreshBtn.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            
            try {
                // Refresh all data
                await loadSalesData();
                await loadProducts();
                
                // Calculate KPIs from actual sales data instead of API
                updateKPIsFromLocalData();
                updateProfitLoss();
                renderSalesTable();
                renderProductsTable();
                updateFilteredCharts();
                
                // Update analytics charts if panel is open
                const analyticsPanel = document.getElementById('analyticsPanel');
                if (analyticsPanel && analyticsPanel.style.display === 'block') {
                    createAnalyticsCharts();
                }
                
                // Update last updated time
                const now = new Date();
                document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
                
                showNotification('âœ… Data refreshed successfully!', 'success');
            } catch (error) {
                showNotification('âŒ Failed to refresh data', 'error');
            } finally {
                // Reset button state
                refreshBtn.disabled = false;
                icon.className = 'fas fa-sync-alt';
            }
        }

        // Initialize the dashboard
        init();
        
        // Setup form handlers when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupUserFormHandlers);
        } else {
            setupUserFormHandlers();
        }
        

        // Auto-refresh every 30 seconds
        setInterval(async () => {
            await checkAPIStatus();
        }, 30000);

        // User Management Functions
        let usersData = [];

        function showUserManagement() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('âŒ Admin access required', 'error');
                return;
            }
            document.getElementById('userManagementModal').style.display = 'block';
            console.log('User Management modal opened, loading users...');
            loadUsers();
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').style.display = 'none';
        }

        async function testAddUser() {
            console.log('Testing add user functionality...');
            const testUserData = {
                name: "Test User " + Date.now(),
                email: "test" + Date.now() + "@example.com",
                password: "test123",
                role: "analyst",
                permissions: ["read", "create", "update"],
                is_active: true
            };

            console.log('Test user data:', testUserData);

            try {
                const headers = getAuthHeaders();
                console.log('Request headers:', headers);
                
                const response = await fetch(`${API_BASE}/api/users/`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(testUserData)
                });

                console.log('Test add user response:', response.status, response.statusText);

                if (response.ok) {
                    const createdUser = await response.json();
                    console.log('Test user created successfully:', createdUser);
                    showNotification('âœ… Test user created successfully', 'success');
                    await loadUsers();
                } else {
                    const error = await response.json();
                    console.error('Failed to create test user:', error);
                    showNotification('âŒ Failed to create test user: ' + error.detail, 'error');
                }
            } catch (error) {
                console.error('Error creating test user:', error);
                showNotification('âŒ Error creating test user: ' + error.message, 'error');
            }
        }

        async function loadUsers() {
            try {
                console.log('Loading users...', { API_BASE, authToken: authToken ? 'present' : 'missing' });
                const response = await fetch(`${API_BASE}/api/users/`, {
                    headers: getAuthHeaders()
                });
                
                console.log('Users response:', response.status, response.statusText);
                
                if (response.ok) {
                    usersData = await response.json();
                    console.log('Users data loaded:', usersData);
                    console.log('Number of users:', usersData.length);
                    renderUsersList();
                    showNotification(`âœ… Users loaded successfully (${usersData.length} users)`, 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load users:', response.status, errorText);
                    throw new Error(`Failed to load users: ${response.status}`);
                }
            } catch (error) {
                showNotification('âŒ Failed to load users: ' + error.message, 'error');
                console.error('Error loading users:', error);
            }
        }

        function renderUsersList() {
            const usersList = document.getElementById('usersList');
            console.log('Rendering users list. Found usersList element:', usersList);
            console.log('Users data to render:', usersData);
            console.log('Number of users to render:', usersData.length);
            
            if (!usersList) {
                console.error('usersList element not found!');
                return;
            }
            
            usersList.innerHTML = '';
            
            if (usersData.length === 0) {
                usersList.innerHTML = '<div class="no-users">No users found</div>';
                return;
            }

            usersData.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-header">
                        <div class="user-info">
                            <div class="user-avatar-large">${user.name.charAt(0).toUpperCase()}</div>
                            <div class="user-details">
                                <h5>${user.name}</h5>
                                <p>${user.email}</p>
                                <span class="user-status ${user.is_active ? 'status-active' : 'status-inactive'}">
                                    ${user.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn-edit" data-user-id="${user.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn-toggle" data-user-id="${user.id}">
                                <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i> 
                                ${user.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="btn-delete" data-user-id="${user.id}" ${currentUser && user.email === currentUser.email ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="user-permissions">
                        <span class="permission-tag ${user.role}">${user.role.toUpperCase()}</span>
                        ${user.permissions && user.permissions.length > 0 ? user.permissions.map(perm => 
                            `<span class="permission-tag">${perm}</span>`
                        ).join('') : '<span class="permission-tag">No permissions</span>'}
                    </div>
                `;
                usersList.appendChild(userCard);
                
                // Add event listeners to the buttons for this user
                const editBtn = userCard.querySelector('.btn-edit');
                const toggleBtn = userCard.querySelector('.btn-toggle');
                const deleteBtn = userCard.querySelector('.btn-delete');
                
                if (editBtn) {
                    editBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Edit button clicked directly for user:', user.id);
                        editUser(user.id);
                        return false;
                    };
                }
                
                if (toggleBtn) {
                    toggleBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Toggle button clicked directly for user:', user.id);
                        toggleUserStatus(user.id);
                        return false;
                    };
                }
                
                if (deleteBtn) {
                    deleteBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Delete button clicked directly for user:', user.id);
                        deleteUser(user.id);
                        return false;
                    };
                }
            });
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const userCards = document.querySelectorAll('.user-card');
            
            userCards.forEach(card => {
                const userName = card.querySelector('h5').textContent.toLowerCase();
                const userEmail = card.querySelector('p').textContent.toLowerCase();
                
                if (userName.includes(searchTerm) || userEmail.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Add User Form Handler
        function setupUserFormHandlers() {
            const addUserForm = document.getElementById('addUserForm');
            console.log('Add user form found:', addUserForm);
            if (addUserForm) {
            addUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Add user form submitted!');
            
            const formData = new FormData(e.target);
            const permissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
            
            console.log('Form data collected:', {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role'),
                permissions: permissions
            });
            
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role'),
                permissions: permissions,
                is_active: true
            };

            console.log('Creating user with data:', userData);

            try {
                const headers = getAuthHeaders();
                console.log('Request headers:', headers);
                console.log('API_BASE:', API_BASE);
                console.log('authToken present:', !!authToken);
                
                const response = await fetch(`${API_BASE}/api/users/`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(userData)
                });

                console.log('Create user response:', response.status, response.statusText);

                if (response.ok) {
                    const createdUser = await response.json();
                    console.log('User created successfully:', createdUser);
                    showNotification('âœ… User created successfully', 'success');
                    e.target.reset();
                    // Immediately refresh the users list
                    console.log('Refreshing users list after creation...');
                    await loadUsers();
                    console.log('Users list refresh completed');
                } else {
                    const error = await response.json();
                    console.error('Failed to create user:', error);
                    throw new Error(error.detail || 'Failed to create user');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showNotification('âŒ Failed to create user: ' + error.message, 'error');
            }
            });
        }}

        // Edit User Form Handler
        const editUserForm = document.getElementById('editUserForm');
        if (editUserForm) {
            editUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userId = formData.get('id');
            const permissions = Array.from(document.querySelectorAll('input[name="editPermissions"]:checked')).map(cb => cb.value);
            
            console.log('Form data collected:', {
                userId: userId,
                name: formData.get('name'),
                email: formData.get('email'),
                role: formData.get('role'),
                permissions: permissions,
                is_active: formData.get('is_active')
            });
            
            const userData = {
                name: formData.get('name'),
                email: formData.get('email'),
                role: formData.get('role'),
                permissions: permissions,
                is_active: formData.get('is_active') === 'true'
            };
            
            // Only include password if provided
            const password = formData.get('password');
            if (password && password.trim() !== '') {
                userData.password = password;
            }

            console.log('Updating user with data:', userData);

            try {
                const response = await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(userData)
                });

                console.log('Update user response:', response.status, response.statusText);

                if (response.ok) {
                    const updatedUser = await response.json();
                    console.log('User updated successfully:', updatedUser);
                    showNotification('âœ… User updated successfully', 'success');
                    closeEditUserModal();
                    // Force refresh the users list
                    console.log('Refreshing users list after update...');
                    await loadUsers();
                } else {
                    const error = await response.json();
                    console.error('Failed to update user:', error);
                    throw new Error(error.detail || 'Failed to update user');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showNotification('âŒ Failed to update user: ' + error.message, 'error');
            }
        });
        }

        async function editUser(userId) {
            console.log('Edit button clicked for user ID:', userId);
            const user = usersData.find(u => u.id === userId);
            if (!user) {
                console.log('User not found:', userId);
                return;
            }

            console.log('Editing user:', user);

            // Populate the edit form with user data
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserStatus').value = user.is_active.toString();
            
            // Clear password field
            document.getElementById('editUserPassword').value = '';
            
            // Set permissions checkboxes
            const permissionCheckboxes = document.querySelectorAll('input[name="editPermissions"]');
            console.log('Found permission checkboxes:', permissionCheckboxes.length);
            console.log('User permissions:', user.permissions);
            
            permissionCheckboxes.forEach(checkbox => {
                const isChecked = user.permissions && user.permissions.includes(checkbox.value);
                checkbox.checked = isChecked;
                console.log(`Setting ${checkbox.value}: ${isChecked}`);
            });
            
            // Show the edit modal
            document.getElementById('editUserModal').style.display = 'block';
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserForm').reset();
        }

        async function toggleUserStatus(userId) {
            console.log('Toggle status button clicked for user ID:', userId);
            const user = usersData.find(u => u.id === userId);
            if (!user) {
                console.log('User not found:', userId);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ is_active: !user.is_active })
                });

                if (response.ok) {
                    showNotification(`âœ… User ${user.is_active ? 'deactivated' : 'activated'} successfully`, 'success');
                    await loadUsers();
                } else {
                    throw new Error('Failed to update user status');
                }
            } catch (error) {
                showNotification('âŒ Failed to update user status', 'error');
            }
        }

        async function deleteUser(userId) {
            console.log('Delete button clicked for user ID:', userId);
            const user = usersData.find(u => u.id === userId);
            if (!user) {
                console.log('User not found:', userId);
                return;
            }

            if (user.email === currentUser.email) {
                showNotification('âŒ Cannot delete your own account', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete user "${user.name}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`${API_BASE}/api/users/${userId}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    if (response.ok) {
                        showNotification('âœ… User deleted successfully', 'success');
                        await loadUsers();
                    } else {
                        throw new Error('Failed to delete user');
                    }
                } catch (error) {
                    showNotification('âŒ Failed to delete user', 'error');
                }
            }
        }
    </script>

    <!-- User Management Modal -->
    <div id="userManagementModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto; z-index: 1002;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb;">
                <h3><i class="fas fa-users-cog"></i> User Management</h3>
                <button class="close" onclick="closeUserManagement()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Add User Section -->
                <div class="user-section">
                    <h4><i class="fas fa-user-plus"></i> Add New User</h4>
                    <form id="addUserForm" class="user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="userName">Full Name</label>
                                <input type="text" id="userName" name="name" required placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label for="userEmail">Email Address</label>
                                <input type="email" id="userEmail" name="email" required placeholder="Enter email address">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="userPassword">Password</label>
                                <input type="password" id="userPassword" name="password" required placeholder="Enter password">
                            </div>
                            <div class="form-group">
                                <label for="userRole">Role</label>
                                <select id="userRole" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="analyst">Analyst</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="userPermissions">Permissions</label>
                                <div class="permissions-grid">
                                    <label><input type="checkbox" name="permissions" value="read"> Read Data</label>
                                    <label><input type="checkbox" name="permissions" value="create"> Create Records</label>
                                    <label><input type="checkbox" name="permissions" value="update"> Update Records</label>
                                    <label><input type="checkbox" name="permissions" value="delete"> Delete Records</label>
                                    <label><input type="checkbox" name="permissions" value="export"> Export Data</label>
                                    <label><input type="checkbox" name="permissions" value="analytics"> View Analytics</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </form>
                </div>

                <!-- Users List Section -->
                <div class="user-section">
                    <h4><i class="fas fa-users"></i> Manage Users</h4>
                    <div class="users-controls">
                        <button class="btn btn-primary" onclick="loadUsers()">
                            <i class="fas fa-sync-alt"></i> Refresh Users
                        </button>
                        <button class="btn btn-success" onclick="testAddUser()" style="margin-left: 10px;">
                            <i class="fas fa-flask"></i> Test Add User
                        </button>
                        <div class="search-box">
                            <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    <div id="usersList" class="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit User</h3>
                <span class="close" onclick="closeEditUserModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <form id="editUserForm" class="user-form">
                    <input type="hidden" id="editUserId" name="id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserName">Full Name</label>
                            <input type="text" id="editUserName" name="name" required placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="editUserEmail">Email Address</label>
                            <input type="email" id="editUserEmail" name="email" required placeholder="Enter email address">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserPassword">New Password (leave blank to keep current)</label>
                            <input type="password" id="editUserPassword" name="password" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label for="editUserRole">Role</label>
                            <select id="editUserRole" name="role" required>
                                <option value="">Select Role</option>
                                <option value="admin">Admin</option>
                                <option value="analyst">Analyst</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserPermissions">Permissions</label>
                            <div class="permissions-grid">
                                <label><input type="checkbox" name="editPermissions" value="read"> Read Data</label>
                                <label><input type="checkbox" name="editPermissions" value="create"> Create Records</label>
                                <label><input type="checkbox" name="editPermissions" value="update"> Update Records</label>
                                <label><input type="checkbox" name="editPermissions" value="delete"> Delete Records</label>
                                <label><input type="checkbox" name="editPermissions" value="export"> Export Data</label>
                                <label><input type="checkbox" name="editPermissions" value="analytics"> View Analytics</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserStatus">Status</label>
                            <select id="editUserStatus" name="is_active">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="login-modal">
            <button class="close-modal" onclick="hideLoginModal()">&times;</button>
            <div class="login-header">
                <h2><i class="fas fa-chart-line"></i> Sales Analytics Pro</h2>
                <p>Sign in to access your dashboard</p>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" name="email" required placeholder="Enter your email">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" name="password" required placeholder="Enter your password">
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="login-submit" id="loginSubmit">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
            
            <div class="demo-credentials">
                <h4><i class="fas fa-info-circle"></i> Demo Credentials</h4>
                <div class="credential"><strong>Admin:</strong> admin@example.com / admin123</div>
                <div class="credential"><strong>Analyst:</strong> analyst@example.com / analyst123</div>
                <div class="credential"><strong>Viewer:</strong> viewer@example.com / viewer123</div>
            </div>
        </div>
    </div>

    <!-- Expenses Calculator Modal -->
    <div class="modal-overlay" id="expensesModal">
        <div class="login-modal">
            <button class="close-modal" onclick="hideExpensesCalculator()">&times;</button>
            <div class="login-header">
                <h2><i class="fas fa-calculator"></i> Expenses Calculator</h2>
                <p>Calculate and track business expenses</p>
            </div>
            
            <form id="expensesForm" onsubmit="calculateExpenses(event)">
                <div class="form-group">
                    <label for="expenseType">Expense Type</label>
                    <select id="expenseType" class="input" required>
                        <option value="">Select Expense Type</option>
                        <option value="operational">Operational Expenses</option>
                        <option value="marketing">Marketing & Advertising</option>
                        <option value="salaries">Salaries & Benefits</option>
                        <option value="rent">Rent & Utilities</option>
                        <option value="equipment">Equipment & Supplies</option>
                        <option value="travel">Travel & Transportation</option>
                        <option value="other">Other Expenses</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expenseAmount">Amount</label>
                    <input type="number" id="expenseAmount" class="input" step="0.01" min="0" required placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label for="expenseDescription">Description</label>
                    <input type="text" id="expenseDescription" class="input" required placeholder="Enter expense description">
                </div>
                
                <div class="form-group">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate" class="input" required>
                </div>
                
                <button type="submit" class="login-submit">
                    <i class="fas fa-plus"></i> Add Expense
                </button>
            </form>
            
            <div class="expenses-summary" id="expensesSummary" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; display: none;">
                <h4 style="margin-bottom: 10px; color: #374151;">Expense Summary</h4>
                <div id="expensesList"></div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                    <strong>Total Expenses: <span id="totalExpenses">$0</span></strong>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
